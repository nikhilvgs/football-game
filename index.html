<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Retro Bowl</title>
<style>
*{margin:0;padding:0;box-sizing:border-box;}
body{background:#1a1a2e;display:flex;justify-content:center;align-items:center;
  min-height:100vh;font-family:'Segoe UI',Tahoma,Geneva,Verdana,sans-serif;
  overflow:hidden;user-select:none;color:#fff;}
#gc{position:relative;width:800px;height:600px;}
canvas{display:block;border-radius:6px;box-shadow:0 0 30px rgba(0,0,0,0.6);}
#sb{position:absolute;top:0;left:0;width:100%;
  display:flex;justify-content:space-between;align-items:center;
  padding:6px 12px;pointer-events:none;z-index:2;}
.sb{background:rgba(0,0,0,0.8);color:#fff;padding:5px 12px;border-radius:5px;font-size:13px;font-weight:bold;letter-spacing:1px;}
#msg{position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);
  color:#fff;font-size:34px;font-weight:bold;
  text-shadow:2px 2px 6px rgba(0,0,0,0.9);
  pointer-events:none;opacity:0;transition:opacity 0.3s;z-index:5;}
#pm{position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);
  display:none;flex-direction:column;gap:8px;z-index:10;
  background:rgba(0,0,0,0.88);padding:18px 24px;border-radius:10px;min-width:240px;}
#pm.show{display:flex;}
#pm h3{color:#f0c040;text-align:center;font-size:16px;margin-bottom:2px;}
#pm button{padding:9px 14px;font-size:14px;font-weight:bold;
  border:2px solid rgba(255,255,255,0.15);border-radius:7px;
  cursor:pointer;transition:all 0.15s;color:#fff;}
#pm button:hover{transform:scale(1.03);filter:brightness(1.2);}
/* === MANAGEMENT SCREENS === */
.screen{position:absolute;top:0;left:0;width:100%;height:100%;
  display:none;flex-direction:column;align-items:center;
  background:#1a1a2e;z-index:25;overflow-y:auto;overflow-x:hidden;}
.screen-header{width:100%;padding:14px 0 8px;text-align:center;
  font-size:22px;font-weight:bold;color:#f0c040;letter-spacing:2px;
  border-bottom:2px solid rgba(240,192,64,0.2);margin-bottom:10px;}
.screen-content{width:100%;flex:1;padding:8px 16px;overflow-y:auto;}
.btn{padding:10px 20px;font-size:14px;font-weight:bold;
  border:2px solid rgba(255,255,255,0.15);border-radius:7px;
  cursor:pointer;transition:all 0.15s;color:#fff;background:rgba(255,255,255,0.1);
  margin:4px;}
.btn:hover{transform:scale(1.03);filter:brightness(1.2);}
.btn:disabled{opacity:0.4;cursor:default;transform:none;filter:none;}
.btn-gold{background:#b8860b;border-color:#f0c040;}
.btn-green{background:#27ae60;border-color:#2ecc71;}
.btn-red{background:#c0392b;border-color:#e74c3c;}
.btn-blue{background:#2980b9;border-color:#3498db;}
.btn-back{position:absolute;top:10px;left:10px;padding:6px 14px;font-size:12px;z-index:30;}
.card{background:rgba(255,255,255,0.08);border-radius:8px;padding:10px 14px;margin:4px 0;
  border:1px solid rgba(255,255,255,0.06);}
.stat-bar{height:8px;background:rgba(255,255,255,0.1);border-radius:4px;overflow:hidden;margin:2px 0;}
.stat-fill{height:100%;border-radius:4px;transition:width 0.3s;}
.fan-bar{width:200px;height:14px;background:rgba(255,255,255,0.1);border-radius:7px;overflow:hidden;display:inline-block;vertical-align:middle;}
.fan-fill{height:100%;border-radius:7px;background:linear-gradient(90deg,#e74c3c,#f0c040,#2ecc71);transition:width 0.3s;}
/* Team select grid */
.team-grid{display:grid;grid-template-columns:repeat(4,1fr);gap:8px;padding:8px;}
.team-btn{padding:12px 8px;border-radius:8px;border:2px solid rgba(255,255,255,0.15);
  cursor:pointer;text-align:center;font-weight:bold;font-size:13px;transition:all 0.15s;color:#fff;}
.team-btn:hover{transform:scale(1.05);filter:brightness(1.2);}
.team-btn .city{font-size:10px;opacity:0.7;margin-bottom:2px;}
/* Roster */
.roster-row{display:flex;align-items:center;gap:8px;padding:8px 10px;cursor:pointer;
  border-radius:6px;transition:background 0.15s;}
.roster-row:hover{background:rgba(255,255,255,0.06);}
.roster-pos{font-size:11px;font-weight:bold;color:#f0c040;width:32px;text-align:center;}
.roster-name{flex:1;font-size:13px;}
.roster-ovr{font-size:20px;font-weight:bold;min-width:36px;text-align:center;}
.roster-meta{font-size:11px;color:#aaa;}
.roster-inj{color:#e74c3c;font-size:11px;font-weight:bold;}
/* Schedule */
.sched-row{display:flex;align-items:center;gap:8px;padding:7px 10px;border-radius:6px;}
.sched-row.current{background:rgba(240,192,64,0.15);border:1px solid rgba(240,192,64,0.3);}
.sched-week{font-size:11px;font-weight:bold;color:#f0c040;width:50px;}
.sched-opp{flex:1;font-size:13px;}
.sched-result{font-size:13px;font-weight:bold;min-width:60px;text-align:right;}
/* Facility cards */
.fac-card{display:flex;flex-direction:column;align-items:center;padding:14px;margin:6px 0;text-align:center;}
.fac-stars{font-size:18px;color:#f0c040;margin:4px 0;}
.fac-desc{font-size:11px;color:#aaa;margin:4px 0;}
/* Draft cards */
.draft-card{display:flex;align-items:center;gap:12px;padding:12px;}
.draft-info{flex:1;}
.draft-pos{font-size:12px;font-weight:bold;color:#f0c040;}
.draft-name{font-size:15px;font-weight:bold;}
.draft-meta{font-size:11px;color:#aaa;}
.draft-ovr{font-size:28px;font-weight:bold;color:#2ecc71;}
/* Post game */
.pg-score{font-size:48px;font-weight:bold;margin:10px 0;}
.pg-result{font-size:24px;font-weight:bold;margin:6px 0;}
/* Player detail overlay */
.player-detail{position:absolute;top:0;left:0;width:100%;height:100%;
  background:rgba(26,26,46,0.95);z-index:35;display:none;flex-direction:column;
  align-items:center;padding:20px;overflow-y:auto;}
.player-detail.show{display:flex;}
.pd-stat-row{display:flex;align-items:center;gap:8px;width:80%;max-width:300px;margin:4px 0;}
.pd-stat-label{width:40px;font-size:12px;color:#aaa;text-align:right;}
.pd-stat-bar{flex:1;height:12px;background:rgba(255,255,255,0.1);border-radius:6px;overflow:hidden;}
.pd-stat-fill{height:100%;border-radius:6px;}
.pd-stat-val{width:28px;font-size:12px;text-align:left;font-weight:bold;}
.inst{color:#888;font-size:12px;margin-top:10px;text-align:center;line-height:1.5;}
.secondary{color:#aaa;font-size:12px;}
.gold{color:#f0c040;}
/* Touch Controls */
#touchControls{display:none;position:absolute;bottom:0;left:0;width:100%;height:160px;
  pointer-events:none;z-index:8;}
#touchControls.show{display:flex;justify-content:space-between;align-items:flex-end;padding:10px 14px;}
#dpad{pointer-events:auto;display:grid;grid-template-columns:50px 50px 50px;grid-template-rows:50px 50px;
  gap:2px;opacity:0.55;}
#dpad .dp{background:rgba(255,255,255,0.25);border:2px solid rgba(255,255,255,0.4);border-radius:8px;
  color:#fff;font-size:22px;font-weight:bold;display:flex;align-items:center;justify-content:center;
  cursor:pointer;-webkit-tap-highlight-color:transparent;touch-action:none;}
#dpad .dp:active,#dpad .dp.pressed{background:rgba(255,255,255,0.5);}
#dpad .dp.blank{background:transparent;border:none;pointer-events:none;}
#actBtns{pointer-events:auto;display:flex;flex-direction:column;gap:6px;align-items:flex-end;opacity:0.55;}
#actBtns .ab{background:rgba(255,255,255,0.25);border:2px solid rgba(255,255,255,0.4);border-radius:8px;
  color:#fff;font-size:11px;font-weight:bold;padding:10px 14px;min-width:52px;text-align:center;
  cursor:pointer;-webkit-tap-highlight-color:transparent;touch-action:none;}
#actBtns .ab:active,#actBtns .ab.pressed{background:rgba(255,255,255,0.5);}
#actBtns .juke-row{display:flex;gap:6px;}
</style>
</head>
<body>
<div id="gc">
  <canvas id="c" width="800" height="600"></canvas>
  <div id="sb">
    <div class="sb" id="sH">YOU: 0</div>
    <div class="sb" id="sI">Q1 | 1st & 10</div>
    <div class="sb" id="sA">CPU: 0</div>
  </div>
  <div id="msg"></div>
  <div id="diceRoll" style="position:absolute;top:28%;left:50%;transform:translate(-50%,-50%);color:#fff;font-size:20px;font-weight:bold;text-align:center;text-shadow:2px 2px 6px rgba(0,0,0,0.9);pointer-events:none;opacity:0;transition:opacity 0.15s;z-index:6;"></div>
  <div id="pm"></div>
  <!-- Management Screens -->
  <div id="teamSelectScreen" class="screen">
    <div class="screen-header">CHOOSE YOUR TEAM</div>
    <div class="screen-content" id="teamSelectContent"></div>
  </div>
  <div id="homeScreen" class="screen">
    <div class="screen-header" id="homeHeader">HOME</div>
    <div class="screen-content" id="homeContent"></div>
  </div>
  <div id="rosterScreen" class="screen">
    <button class="btn btn-back" onclick="showScreen('home');renderHome();">BACK</button>
    <div class="screen-header">ROSTER</div>
    <div class="screen-content" id="rosterContent"></div>
    <div id="playerDetail" class="player-detail"></div>
  </div>
  <div id="scheduleScreen" class="screen">
    <button class="btn btn-back" onclick="showScreen('home');renderHome();">BACK</button>
    <div class="screen-header">SCHEDULE</div>
    <div class="screen-content" id="scheduleContent"></div>
  </div>
  <div id="facilitiesScreen" class="screen">
    <button class="btn btn-back" onclick="showScreen('home');renderHome();">BACK</button>
    <div class="screen-header">FACILITIES</div>
    <div class="screen-content" id="facilitiesContent"></div>
  </div>
  <div id="draftScreen" class="screen">
    <div class="screen-header">DRAFT</div>
    <div class="screen-content" id="draftContent"></div>
  </div>
  <div id="offseasonScreen" class="screen">
    <div class="screen-header">OFF-SEASON</div>
    <div class="screen-content" id="offseasonContent"></div>
  </div>
  <div id="freeAgentScreen" class="screen">
    <button class="btn btn-back" onclick="showScreen('home');renderHome();">BACK</button>
    <div class="screen-header">FREE AGENTS</div>
    <div class="screen-content" id="freeAgentContent"></div>
  </div>
  <div id="postGameScreen" class="screen">
    <div class="screen-header">GAME OVER</div>
    <div class="screen-content" id="postGameContent"></div>
  </div>
  <!-- Touch Controls for iPad/Mobile -->
  <div id="touchControls">
    <div id="dpad">
      <div class="dp blank"></div>
      <div class="dp" data-key="arrowup">â–²</div>
      <div class="dp blank"></div>
      <div class="dp" data-key="arrowleft">â—€</div>
      <div class="dp blank"></div>
      <div class="dp" data-key="arrowright">â–¶</div>
      <div class="dp blank"></div>
      <div class="dp" data-key="arrowdown">â–¼</div>
      <div class="dp blank"></div>
    </div>
    <div id="actBtns">
      <div class="ab" data-key=" ">SPRINT</div>
      <div class="juke-row">
        <div class="ab" data-key="q">âŸµ JUKE</div>
        <div class="ab" data-key="e">JUKE âŸ¶</div>
      </div>
    </div>
  </div>
</div>
<script>
// =============================================
// === MANAGEMENT LAYER ===
// =============================================

const TEAMS=[
{name:'Titans',city:'Nashville',abbr:'TEN',c1:'#4B92DB',c2:'#C8102E',diff:3},
{name:'Wolves',city:'Minnesota',abbr:'MIN',c1:'#4F5D75',c2:'#FFC107',diff:2},
{name:'Eagles',city:'Philadelphia',abbr:'PHI',c1:'#004C54',c2:'#A5ACAF',diff:4},
{name:'Sharks',city:'San Jose',abbr:'SJ',c1:'#006D75',c2:'#EA7200',diff:2},
{name:'Bears',city:'Chicago',abbr:'CHI',c1:'#0B162A',c2:'#C83803',diff:3},
{name:'Hawks',city:'Atlanta',abbr:'ATL',c1:'#A71930',c2:'#000000',diff:4},
{name:'Cobras',city:'Arizona',abbr:'ARI',c1:'#97233F',c2:'#FFB612',diff:1},
{name:'Storm',city:'Tampa Bay',abbr:'TB',c1:'#0A0A3C',c2:'#FF7900',diff:2},
{name:'Panthers',city:'Carolina',abbr:'CAR',c1:'#0085CA',c2:'#BFC0BF',diff:3},
{name:'Stallions',city:'Denver',abbr:'DEN',c1:'#002244',c2:'#FB4F14',diff:3},
{name:'Foxes',city:'Cincinnati',abbr:'CIN',c1:'#FB4F14',c2:'#000000',diff:1},
{name:'Dragons',city:'Las Vegas',abbr:'LV',c1:'#A5ACAF',c2:'#000000',diff:4},
{name:'Knights',city:'New York',abbr:'NY',c1:'#003A70',c2:'#C9243F',diff:5},
{name:'Thunder',city:'Oklahoma',abbr:'OKC',c1:'#007AC1',c2:'#EF6C00',diff:2},
{name:'Vipers',city:'Miami',abbr:'MIA',c1:'#008E97',c2:'#FC4C02',diff:3},
{name:'Bulldogs',city:'Cleveland',abbr:'CLE',c1:'#311D00',c2:'#FF3C00',diff:1},
];

const FIRST_NAMES=['James','John','Robert','Michael','David','Chris','Daniel','Matt','Josh','Andrew',
  'Ryan','Justin','Brandon','Tyler','Kevin','Aaron','Marcus','Derrick','Jamal','DeAndre',
  'Tyreek','Lamar','Patrick','Dak','Jalen','Tua','Trevor','Justin','Joe','Kyler',
  'Davante','Stefon','AJ','Terry','DK','Deebo','CeeDee','Amari','Keenan','Cooper',
  'Saquon','Dalvin','Alvin','Nick','Derrick','Jonathan','Austin','Najee','Javonte','Breece'];
const LAST_NAMES=['Smith','Johnson','Williams','Brown','Jones','Davis','Wilson','Moore','Taylor','Anderson',
  'Thomas','Jackson','White','Harris','Martin','Thompson','Garcia','Martinez','Robinson','Clark',
  'Lewis','Lee','Walker','Hall','Allen','Young','King','Wright','Hill','Scott',
  'Green','Adams','Baker','Nelson','Carter','Mitchell','Turner','Phillips','Campbell','Parker',
  'Evans','Edwards','Collins','Stewart','Morris','Reed','Cook','Morgan','Bell','Murphy'];

const POSITIONS=['QB','WR1','WR2','WR3','RB','OL','OL','OL','OL','OL'];

// Save state
let S={teamIdx:0,roster:[],season:1,week:1,schedule:[],credits:50,fans:50,
  facilities:{stadium:1,training:1,rehab:1},wins:0,losses:0,
  isPlayoffs:false,playoffRound:0,draftClass:[],otherTeams:[],freeAgents:[]};

function clamp(v,mn,mx){return Math.max(mn,Math.min(mx,v));}

function randName(){
  return FIRST_NAMES[Math.floor(Math.random()*FIRST_NAMES.length)]+' '+
         LAST_NAMES[Math.floor(Math.random()*LAST_NAMES.length)];
}

function genPlayer(pos,tier){
  let ranges;
  switch(tier){
    case 1:ranges=[82,99];break;
    case 2:ranges=[68,88];break;
    case 3:ranges=[52,75];break;
    case 4:default:ranges=[38,60];break;
  }
  function rs(){return ranges[0]+Math.floor(Math.random()*(ranges[1]-ranges[0]+1));}
  let stats={spd:rs(),str:rs(),arm:rs(),cat:rs(),sta:rs()};
  // Position weighting
  const p=pos.replace(/[0-9]/g,'');
  if(p==='QB'){stats.arm=clamp(stats.arm+10,ranges[0],99);stats.spd=clamp(stats.spd-5,ranges[0],99);}
  else if(p==='WR'){stats.spd=clamp(stats.spd+8,ranges[0],99);stats.cat=clamp(stats.cat+8,ranges[0],99);}
  else if(p==='RB'){stats.spd=clamp(stats.spd+6,ranges[0],99);stats.str=clamp(stats.str+6,ranges[0],99);}
  else if(p==='OL'){stats.str=clamp(stats.str+10,ranges[0],99);stats.sta=clamp(stats.sta+8,ranges[0],99);stats.spd=clamp(stats.spd-10,ranges[0],99);}
  else if(p==='CB'){stats.spd=clamp(stats.spd+10,ranges[0],99);stats.cat=clamp(stats.cat+6,ranges[0],99);}
  else if(p==='LB'){stats.str=clamp(stats.str+6,ranges[0],99);stats.spd=clamp(stats.spd+6,ranges[0],99);}
  else if(p==='SF'){stats.spd=clamp(stats.spd+8,ranges[0],99);stats.cat=clamp(stats.cat+4,ranges[0],99);}
  else if(p==='DL'){stats.str=clamp(stats.str+10,ranges[0],99);stats.sta=clamp(stats.sta+8,ranges[0],99);stats.spd=clamp(stats.spd-8,ranges[0],99);}
  const ovr=calcOVR(pos,stats);
  const age=21+Math.floor(Math.random()*11);
  const salary=Math.floor(ovr/8);
  return {name:randName(),pos,stats,ovr,age,salary,morale:50,injWeeks:0};
}

function calcOVR(pos,stats){
  const p=pos.replace(/[0-9]/g,'');
  let w;
  switch(p){
    case 'QB':w={spd:0.1,str:0.1,arm:0.45,cat:0.1,sta:0.25};break;
    case 'WR':w={spd:0.35,str:0.05,arm:0.05,cat:0.4,sta:0.15};break;
    case 'RB':w={spd:0.35,str:0.25,arm:0.0,cat:0.1,sta:0.3};break;
    case 'OL':w={spd:0.05,str:0.45,arm:0.0,cat:0.0,sta:0.5};break;
    case 'CB':w={spd:0.4,str:0.05,arm:0.0,cat:0.35,sta:0.2};break;
    case 'LB':w={spd:0.3,str:0.3,arm:0.0,cat:0.1,sta:0.3};break;
    case 'SF':w={spd:0.35,str:0.05,arm:0.0,cat:0.3,sta:0.3};break;
    case 'DL':w={spd:0.1,str:0.45,arm:0.0,cat:0.0,sta:0.45};break;
    default:w={spd:0.2,str:0.2,arm:0.2,cat:0.2,sta:0.2};break;
  }
  return Math.round(stats.spd*w.spd+stats.str*w.str+stats.arm*w.arm+stats.cat*w.cat+stats.sta*w.sta);
}

function genRoster(){
  const roster=[];
  roster.push(genPlayer('QB',2));
  roster.push(genPlayer('WR1',2));
  roster.push(genPlayer('WR2',2));
  roster.push(genPlayer('WR3',3));
  roster.push(genPlayer('RB',2));
  for(let i=0;i<5;i++)roster.push(genPlayer('OL',3));
  // Defensive players
  roster.push(genPlayer('CB',3));
  roster.push(genPlayer('CB',3));
  roster.push(genPlayer('LB',3));
  roster.push(genPlayer('LB',3));
  roster.push(genPlayer('SF',3));
  roster.push(genPlayer('DL',3));
  return roster;
}

function genSchedule(teamIdx){
  const sched=[];
  const others=[];
  for(let i=0;i<TEAMS.length;i++){if(i!==teamIdx)others.push(i);}
  for(let w=0;w<13;w++){
    const oppIdx=others[w%others.length];
    sched.push({oppIdx,result:null,myScore:0,oppScore:0});
  }
  // Shuffle schedule
  for(let i=sched.length-1;i>0;i--){
    const j=Math.floor(Math.random()*(i+1));
    [sched[i],sched[j]]=[sched[j],sched[i]];
  }
  return sched;
}

function genOtherTeams(){
  const ot=[];
  for(let i=0;i<TEAMS.length;i++){
    if(i===S.teamIdx){ot.push({wins:0,losses:0});continue;}
    ot.push({wins:0,losses:0});
  }
  return ot;
}

function simulateOtherGames(){
  // Each week, simulate wins/losses for other teams
  for(let i=0;i<TEAMS.length;i++){
    if(i===S.teamIdx)continue;
    const t=S.otherTeams[i];
    if((t.wins+t.losses)>=13)continue;
    // Win chance based on inverse difficulty
    const winChance=0.3+((5-TEAMS[i].diff)/5)*0.4;
    if(Math.random()<winChance)t.wins++;else t.losses++;
  }
}

function genDraftClass(){
  const dc=[];
  const positions=['QB','WR1','WR2','RB','OL','CB','LB'];
  for(let i=0;i<7;i++){
    const pos=positions[i%positions.length];
    const tier=1+Math.floor(Math.random()*3); // tier 1-3
    dc.push(genPlayer(pos,tier));
  }
  return dc;
}

function genFreeAgents(){
  const fa=[];
  // Guarantee some good defensive free agents (tier 1-2)
  const defPositions=['CB','LB','SF','DL'];
  for(let i=0;i<4;i++){
    const pos=defPositions[i];
    const tier=1+Math.floor(Math.random()*2);
    fa.push(genPlayer(pos,tier));
  }
  // Fill rest with mixed positions
  const positions=['QB','WR1','WR2','WR3','RB','OL','CB','LB','SF','DL'];
  const count=5+Math.floor(Math.random()*5); // 5-9 more players
  for(let i=0;i<count;i++){
    const pos=positions[Math.floor(Math.random()*positions.length)];
    const tier=2+Math.floor(Math.random()*3);
    fa.push(genPlayer(pos,tier));
  }
  S.freeAgents=fa;
}

function saveGame(){
  localStorage.setItem('retroBowlSave',JSON.stringify(S));
}
function loadGame(){
  const d=localStorage.getItem('retroBowlSave');
  if(d){S=JSON.parse(d);if(!S.freeAgents)S.freeAgents=[];return true;}
  return false;
}

function newGame(teamIdx){
  S.teamIdx=teamIdx;
  S.roster=genRoster();
  S.season=1;S.week=1;
  S.schedule=genSchedule(teamIdx);
  S.credits=50;S.fans=50;
  S.facilities={stadium:1,training:1,rehab:1};
  S.wins=0;S.losses=0;
  S.isPlayoffs=false;S.playoffRound=0;
  S.draftClass=[];
  S.otherTeams=genOtherTeams();
  saveGame();
}

// === SCREEN MANAGEMENT ===
function showScreen(id){
  document.querySelectorAll('.screen').forEach(s=>s.style.display='none');
  const cv=document.getElementById('c');
  cv.style.display=id==='game'?'block':'none';
  ['sb','msg','pm','diceRoll'].forEach(e=>{
    document.getElementById(e).style.display=id==='game'?'':'none';
  });
  if(id!=='game'){
    const el=document.getElementById(id+'Screen');
    if(el)el.style.display='flex';
    showTouchControls(false);
  }
}

// === DYNAMIC GAME CONSTANTS ===
let gBALL_SPD=11, gQB_SPD=3, gCARRIER_SPD=3.8, gSPRINT_SPD=5.2;
let gSTAM_MAX=100, gCATCH_R=28, gBLOCK_START=55, gBLOCK_FULL=140;

function setGameConstants(){
  const qb=S.roster.find(p=>p.pos==='QB');
  const wrs=S.roster.filter(p=>p.pos.startsWith('WR'));
  const rb=S.roster.find(p=>p.pos==='RB');
  const ols=S.roster.filter(p=>p.pos==='OL');
  const avgCat=wrs.length?wrs.reduce((s,w)=>s+w.stats.cat,0)/wrs.length:50;
  const avgStr=ols.length?ols.reduce((s,o)=>s+o.stats.str,0)/ols.length:50;
  gBALL_SPD=9+(qb?qb.stats.arm:50)/25;
  gCARRIER_SPD=2.0+(rb?rb.stats.spd:50)/50;
  gSPRINT_SPD=3.0+(rb?rb.stats.spd:50)/40;
  gCATCH_R=30+avgCat/5;
  gBLOCK_START=40+avgStr/4;
  gBLOCK_FULL=100+avgStr/2;
  gQB_SPD=1.5+(qb?qb.stats.spd:50)/60;
  gSTAM_MAX=80+(rb?rb.stats.sta:50)/4;
}

// === RENDER: TEAM SELECT ===
function renderTeamSelect(){
  const el=document.getElementById('teamSelectContent');
  let h='<div class="team-grid">';
  TEAMS.forEach((t,i)=>{
    h+=`<div class="team-btn" style="background:${t.c1};border-color:${t.c2}" onclick="selectTeam(${i})">
      <div class="city">${t.city}</div>${t.name}
      <div style="font-size:9px;opacity:0.6;margin-top:2px;">${'*'.repeat(t.diff)} difficulty</div>
    </div>`;
  });
  h+='</div>';
  el.innerHTML=h;
}

function selectTeam(idx){
  newGame(idx);
  genFreeAgents();
  saveGame();
  showScreen('home');renderHome();
}

// === RENDER: HOME SCREEN ===
function renderHome(){
  const t=TEAMS[S.teamIdx];
  document.getElementById('homeHeader').textContent=t.city+' '+t.name;
  document.getElementById('homeHeader').style.color=t.c2==='#000000'?t.c1:t.c2;
  const el=document.getElementById('homeContent');
  let h='<div style="text-align:center;padding:10px 0">';
  h+=`<div style="font-size:16px;font-weight:bold;color:${t.c1}">Season ${S.season}</div>`;
  h+=`<div style="font-size:28px;font-weight:bold;margin:6px 0">${S.wins} - ${S.losses}</div>`;
  h+=`<div style="margin:8px 0"><span class="secondary">Credits:</span> <span class="gold" style="font-size:18px;font-weight:bold">${S.credits}</span></div>`;
  h+=`<div style="margin:8px 0"><span class="secondary">Fans:</span> <div class="fan-bar"><div class="fan-fill" style="width:${S.fans}%"></div></div> <span style="font-size:12px">${S.fans}%</span></div>`;

  if(S.isPlayoffs){
    const roundNames=['Divisional','Conference','Championship'];
    const rn=roundNames[S.playoffRound]||'Championship';
    h+=`<div style="margin:10px 0;font-size:14px;color:#f0c040">PLAYOFFS - ${rn} Round</div>`;
    h+=`<button class="btn btn-green" style="font-size:18px;padding:14px 40px;margin:10px" onclick="startGame()">PLAY PLAYOFF GAME</button>`;
  } else if(S.week<=13){
    const opp=TEAMS[S.schedule[S.week-1].oppIdx];
    h+=`<div style="margin:10px 0;font-size:14px">Week ${S.week} vs <span style="color:${opp.c1};font-weight:bold">${opp.city} ${opp.name}</span></div>`;
    // Check for injured starters
    const injured=S.roster.filter(p=>p.injWeeks>0);
    if(injured.length>0){
      h+=`<div style="font-size:11px;color:#e74c3c;margin:4px 0">Injured: ${injured.map(p=>p.name+' ('+p.injWeeks+'wk)').join(', ')}</div>`;
    }
    h+=`<button class="btn btn-green" style="font-size:18px;padding:14px 40px;margin:10px" onclick="startGame()">PLAY GAME</button>`;
  } else if(S.draftClass.length===0 && !S.draftDone){
    h+=`<div style="margin:10px 0;font-size:14px;color:#f0c040">Season Complete!</div>`;
    h+=`<button class="btn btn-gold" style="font-size:16px;padding:12px 30px;margin:10px" onclick="goToDraft()">DRAFT</button>`;
  } else if(S.draftDone && !S.offseasonDone){
    h+=`<button class="btn btn-blue" style="font-size:16px;padding:12px 30px;margin:10px" onclick="goToOffseason()">OFF-SEASON</button>`;
  }
  h+='</div>';
  h+='<div style="display:flex;gap:8px;justify-content:center;flex-wrap:wrap;margin:10px 0">';
  h+='<button class="btn" onclick="showScreen(\'roster\');renderRoster();">ROSTER</button>';
  h+='<button class="btn" onclick="showScreen(\'schedule\');renderSchedule();">SCHEDULE</button>';
  h+='<button class="btn" onclick="showScreen(\'facilities\');renderFacilities();">FACILITIES</button>';
  h+='<button class="btn btn-blue" onclick="showScreen(\'freeAgent\');renderFreeAgents();">FREE AGENTS</button>';
  h+='</div>';
  h+='<div style="text-align:center;margin-top:10px"><button class="btn btn-red" style="font-size:11px;padding:6px 14px" onclick="if(confirm(\'Start a new game? Current save will be lost.\')){localStorage.removeItem(\'retroBowlSave\');location.reload();}">NEW GAME</button></div>';
  el.innerHTML=h;
}

// === RENDER: ROSTER ===
function renderRoster(){
  const el=document.getElementById('rosterContent');
  const totalSalary=S.roster.reduce((s,p)=>s+p.salary,0);
  let h=`<div style="text-align:center;margin-bottom:8px"><span class="secondary">Total Salary:</span> <span class="gold">${totalSalary}</span></div>`;
  S.roster.forEach((p,i)=>{
    const moraleEmoji=p.morale>=70?'ðŸ˜Š':p.morale>=40?'ðŸ˜':'ðŸ˜Ÿ';
    const injText=p.injWeeks>0?`<span class="roster-inj">INJ ${p.injWeeks}wk</span>`:'';
    const ovrColor=p.ovr>=80?'#2ecc71':p.ovr>=65?'#f0c040':'#e74c3c';
    h+=`<div class="roster-row card" onclick="showPlayerDetail(${i})">
      <div class="roster-pos">${p.pos}</div>
      <div class="roster-name">${p.name}</div>
      <div class="roster-ovr" style="color:${ovrColor}">${p.ovr}</div>
      <div class="roster-meta">${moraleEmoji} Age:${p.age} $${p.salary}</div>
      ${injText}
    </div>`;
  });
  el.innerHTML=h;
  document.getElementById('playerDetail').classList.remove('show');
}

function showPlayerDetail(idx){
  const p=S.roster[idx];
  const pd=document.getElementById('playerDetail');
  const statNames=['spd','str','arm','cat','sta'];
  const statLabels=['SPD','STR','ARM','CAT','STA'];
  const statColors=['#3498db','#e74c3c','#f0c040','#2ecc71','#9b59b6'];
  let h=`<button class="btn" style="align-self:flex-start;margin-bottom:10px" onclick="document.getElementById('playerDetail').classList.remove('show')">BACK</button>`;
  h+=`<div style="font-size:20px;font-weight:bold;margin:8px 0">${p.name}</div>`;
  h+=`<div style="font-size:14px;color:#f0c040;margin-bottom:4px">${p.pos}</div>`;
  const ovrColor=p.ovr>=80?'#2ecc71':p.ovr>=65?'#f0c040':'#e74c3c';
  h+=`<div style="font-size:40px;font-weight:bold;color:${ovrColor};margin:6px 0">${p.ovr}</div>`;
  h+=`<div class="secondary">Age: ${p.age} | Salary: $${p.salary} | Morale: ${p.morale}</div>`;
  if(p.injWeeks>0)h+=`<div style="color:#e74c3c;font-weight:bold;margin:4px 0">INJURED - ${p.injWeeks} week(s)</div>`;
  h+=`<div style="margin:14px 0;width:80%;max-width:300px">`;
  for(let i=0;i<statNames.length;i++){
    const val=p.stats[statNames[i]];
    h+=`<div class="pd-stat-row">
      <div class="pd-stat-label">${statLabels[i]}</div>
      <div class="pd-stat-bar"><div class="pd-stat-fill" style="width:${val}%;background:${statColors[i]}"></div></div>
      <div class="pd-stat-val">${val}</div>
    </div>`;
  }
  h+=`</div>`;
  h+=`<div style="display:flex;gap:8px;margin-top:10px">`;
  h+=`<button class="btn btn-gold" onclick="trainPlayer(${idx})" ${S.credits<5?'disabled':''}>TRAIN ($5)</button>`;
  h+=`<button class="btn btn-red" onclick="cutPlayer(${idx})">CUT</button>`;
  h+=`</div>`;
  pd.innerHTML=h;
  pd.classList.add('show');
}

function trainPlayer(idx){
  if(S.credits<5)return;
  S.credits-=5;
  const p=S.roster[idx];
  const statKeys=['spd','str','arm','cat','sta'];
  const boost=1+Math.floor(Math.random()*(1+S.facilities.training));
  const stat=statKeys[Math.floor(Math.random()*statKeys.length)];
  p.stats[stat]=Math.min(99,p.stats[stat]+boost);
  p.ovr=calcOVR(p.pos,p.stats);
  p.salary=Math.floor(p.ovr/8);
  p.morale=clamp(p.morale+3,0,100);
  saveGame();
  showPlayerDetail(idx);
  renderRoster();
}

function cutPlayer(idx){
  const p=S.roster[idx];
  // Morale hit for all
  S.roster.forEach(pl=>pl.morale=clamp(pl.morale-5,0,100));
  // Actually remove the player from the roster
  S.roster.splice(idx,1);
  saveGame();
  document.getElementById('playerDetail').classList.remove('show');
  renderRoster();
}

// === RENDER: FREE AGENTS ===
function renderFreeAgents(){
  const el=document.getElementById('freeAgentContent');
  const rosterFull=S.roster.length>=16;
  let h='<div style="text-align:center;margin-bottom:8px"><span class="secondary">Credits:</span> <span class="gold">'+S.credits+'</span> | <span class="secondary">Roster:</span> '+S.roster.length+'/16</div>';
  if(!S.freeAgents||S.freeAgents.length===0){
    genFreeAgents();}
  if(S.freeAgents.length===0){
    h+='<div style="text-align:center;color:#aaa;margin-top:20px">No free agents available.</div>';
  } else {
    S.freeAgents.forEach((p,i)=>{
      const ovrColor=p.ovr>=80?'#2ecc71':p.ovr>=65?'#f0c040':'#e74c3c';
      const canSign=!rosterFull&&S.credits>=p.salary;
      h+='<div class="card draft-card">';
      h+='<div class="draft-ovr" style="color:'+ovrColor+'">'+p.ovr+'</div>';
      h+='<div class="draft-info">';
      h+='<div class="draft-pos">'+p.pos+'</div>';
      h+='<div class="draft-name">'+p.name+'</div>';
      h+='<div class="draft-meta">Age: '+p.age+' | SPD:'+p.stats.spd+' STR:'+p.stats.str+' ARM:'+p.stats.arm+' CAT:'+p.stats.cat+' STA:'+p.stats.sta+'</div>';
      h+='<div class="draft-meta">Salary: $'+p.salary+'</div>';
      h+='</div>';
      h+='<button class="btn btn-green" onclick="signFreeAgent('+i+')" '+(canSign?'':'disabled')+'>SIGN</button>';
      h+='</div>';
    });
  }
  el.innerHTML=h;
}

function signFreeAgent(idx){
  if(!S.freeAgents||idx<0||idx>=S.freeAgents.length)return;
  const p=S.freeAgents[idx];
  if(S.roster.length>=16||S.credits<p.salary)return;
  S.credits-=p.salary;
  S.roster.push(p);
  S.freeAgents.splice(idx,1);
  // Add a replacement free agent
  const positions=['QB','WR1','WR2','WR3','RB','OL','CB','LB','SF','DL'];
  const pos=positions[Math.floor(Math.random()*positions.length)];
  const tier=2+Math.floor(Math.random()*3);
  S.freeAgents.push(genPlayer(pos,tier));
  saveGame();
  renderFreeAgents();
}

// === RENDER: SCHEDULE ===
function renderSchedule(){
  const el=document.getElementById('scheduleContent');
  let h='';
  S.schedule.forEach((g,i)=>{
    const opp=TEAMS[g.oppIdx];
    const isCurrent=i===(S.week-1)&&!S.isPlayoffs;
    const resultText=g.result?`${g.result} ${g.myScore}-${g.oppScore}`:'-';
    const resultColor=g.result==='W'?'#2ecc71':g.result==='L'?'#e74c3c':'#aaa';
    h+=`<div class="sched-row card ${isCurrent?'current':''}">
      <div class="sched-week">Week ${i+1}</div>
      <div class="sched-opp">vs <span style="color:${opp.c1}">${opp.abbr}</span> ${opp.name}</div>
      <div class="sched-result" style="color:${resultColor}">${resultText}</div>
    </div>`;
  });
  if(S.isPlayoffs){
    const roundNames=['Divisional','Conference','Championship'];
    for(let r=0;r<3;r++){
      const active=S.isPlayoffs&&S.playoffRound===r;
      h+=`<div class="sched-row card ${active?'current':''}" style="border-left:3px solid #f0c040">
        <div class="sched-week" style="color:#f0c040">${roundNames[r]}</div>
        <div class="sched-opp">${r<S.playoffRound?'Completed':r===S.playoffRound?'NEXT':'Upcoming'}</div>
        <div class="sched-result" style="color:#f0c040">${r<S.playoffRound?'W':'-'}</div>
      </div>`;
    }
  }
  el.innerHTML=h;
}

// === RENDER: FACILITIES ===
function renderFacilities(){
  const el=document.getElementById('facilitiesContent');
  const facs=[
    {key:'stadium',name:'Stadium',desc:'More fans gained per win',icon:'ðŸŸï¸'},
    {key:'training',name:'Training Center',desc:'Better training stat boosts',icon:'ðŸ‹ï¸'},
    {key:'rehab',name:'Rehab Facility',desc:'Fewer and shorter injuries',icon:'ðŸ¥'},
  ];
  let h='';
  facs.forEach(f=>{
    const level=S.facilities[f.key];
    const cost=level*10;
    const maxed=level>=5;
    const canAfford=S.credits>=cost;
    h+=`<div class="card fac-card">
      <div style="font-size:28px">${f.icon}</div>
      <div style="font-size:16px;font-weight:bold;margin:4px 0">${f.name}</div>
      <div class="fac-stars">${'â˜…'.repeat(level)}${'â˜†'.repeat(5-level)}</div>
      <div class="fac-desc">${f.desc}</div>
      ${maxed?'<div style="color:#2ecc71;font-size:12px;margin-top:6px">MAX LEVEL</div>':
      `<button class="btn btn-gold" onclick="upgradeFacility('${f.key}')" ${canAfford?'':'disabled'}>UPGRADE ($${cost})</button>`}
    </div>`;
  });
  h+=`<div style="text-align:center;margin-top:8px" class="secondary">Credits: ${S.credits}</div>`;
  el.innerHTML=h;
}

function upgradeFacility(key){
  const level=S.facilities[key];
  const cost=level*10;
  if(S.credits<cost||level>=5)return;
  S.credits-=cost;
  S.facilities[key]++;
  S.roster.forEach(p=>p.morale=clamp(p.morale+2,0,100));
  saveGame();
  renderFacilities();
}

// === RENDER: DRAFT ===
function goToDraft(){
  S.draftClass=genDraftClass();
  saveGame();
  showScreen('draft');renderDraft();
}

function renderDraft(){
  const el=document.getElementById('draftContent');
  let h='<div style="text-align:center;margin-bottom:8px;font-size:13px" class="secondary">Pick one player to add to your roster</div>';
  S.draftClass.forEach((p,i)=>{
    const ovrColor=p.ovr>=80?'#2ecc71':p.ovr>=65?'#f0c040':'#e74c3c';
    h+=`<div class="card draft-card">
      <div class="draft-ovr" style="color:${ovrColor}">${p.ovr}</div>
      <div class="draft-info">
        <div class="draft-pos">${p.pos}</div>
        <div class="draft-name">${p.name}</div>
        <div class="draft-meta">Age: ${p.age} | SPD:${p.stats.spd} STR:${p.stats.str} ARM:${p.stats.arm} CAT:${p.stats.cat} STA:${p.stats.sta}</div>
      </div>
      <button class="btn btn-green" onclick="draftPlayer(${i})">DRAFT</button>
    </div>`;
  });
  el.innerHTML=h;
}

function draftPlayer(idx){
  const dp=S.draftClass[idx];
  if(S.roster.length>=16){
    // Cut lowest OVR non-QB
    let worstIdx=-1,worstOvr=Infinity;
    S.roster.forEach((p,i)=>{
      if(p.pos!=='QB'&&p.ovr<worstOvr){worstOvr=p.ovr;worstIdx=i;}
    });
    if(worstIdx>=0)S.roster.splice(worstIdx,1);
  }
  S.roster.push(dp);
  S.draftClass=[];
  S.draftDone=true;
  saveGame();
  showScreen('home');renderHome();
}

// === RENDER: OFFSEASON ===
function goToOffseason(){
  showScreen('offseason');renderOffseason();
}

function renderOffseason(){
  const el=document.getElementById('offseasonContent');
  let log=[];
  // Age all players
  S.roster.forEach(p=>{p.age++;});
  log.push('All players aged +1 year.');
  // Retirements (age 34+, 50% chance)
  const retirees=[];
  S.roster=S.roster.filter(p=>{
    if(p.age>=34&&Math.random()<0.5){retirees.push(p);return false;}
    return true;
  });
  if(retirees.length>0){
    log.push('Retired: '+retirees.map(p=>p.name+' ('+p.pos+')').join(', '));
    // Replace retirees
    retirees.forEach(r=>{S.roster.push(genPlayer(r.pos,4));});
    log.push('Replacement free agents signed.');
  }
  // Stat declines for 30+
  S.roster.forEach(p=>{
    if(p.age>=30){
      const statKeys=['spd','str','arm','cat','sta'];
      const decline=2+Math.floor(Math.random()*4);
      const stat=statKeys[Math.floor(Math.random()*statKeys.length)];
      const oldVal=p.stats[stat];
      p.stats[stat]=Math.max(30,p.stats[stat]-decline);
      p.ovr=calcOVR(p.pos,p.stats);
      p.salary=Math.floor(p.ovr/8);
      if(p.stats[stat]<oldVal)log.push(`${p.name}: ${stat.toUpperCase()} declined by ${oldVal-p.stats[stat]}`);
    }
  });
  // Clear injuries
  S.roster.forEach(p=>{p.injWeeks=0;});
  log.push('All injuries cleared.');
  // Reset morale to 50
  S.roster.forEach(p=>{p.morale=50;});
  log.push('Morale reset.');

  let h='<div style="padding:10px">';
  log.forEach(l=>{
    h+=`<div class="card" style="padding:8px 12px;font-size:13px">${l}</div>`;
  });
  h+=`<div style="text-align:center;margin-top:16px">
    <button class="btn btn-green" style="font-size:16px;padding:12px 30px" onclick="startNewSeason()">START NEW SEASON</button>
  </div>`;
  h+='</div>';
  el.innerHTML=h;
  saveGame();
}

function startNewSeason(){
  S.season++;
  S.week=1;
  S.wins=0;S.losses=0;
  S.schedule=genSchedule(S.teamIdx);
  S.isPlayoffs=false;S.playoffRound=0;
  S.draftDone=false;S.offseasonDone=false;
  S.otherTeams=genOtherTeams();
  genFreeAgents();
  saveGame();
  showScreen('home');renderHome();
}

// === POST-GAME ===
function onGameOver(hs,as){
  inGame=false;
  const won=hs>as;
  const margin=Math.abs(hs-as);
  const base=won?8+Math.min(7,Math.floor(margin/7)):3;
  const earned=Math.round(base*(S.fans/100+0.5));
  S.credits+=earned;
  S.fans=clamp(S.fans+(won?3+S.facilities.stadium*2:-5),0,100);
  // Injury rolls
  const injuries=[];
  S.roster.forEach(p=>{
    if(p.injWeeks>0)return;
    if(Math.random()<0.08-S.facilities.rehab*0.008){
      p.injWeeks=1+Math.floor(Math.random()*3);
      injuries.push(p.name+' ('+p.injWeeks+'wk)');
    }
  });
  // Morale
  S.roster.forEach(p=>p.morale=clamp(p.morale+(won?5:-3),0,100));
  // Heal existing injuries
  S.roster.forEach(p=>{if(p.injWeeks>0)p.injWeeks=Math.max(0,p.injWeeks-1);});

  if(S.isPlayoffs){
    if(won){
      S.playoffRound++;
      if(S.playoffRound>=3){
        // Won championship!
        S.isPlayoffs=false;
      }
    } else {
      // Eliminated
      S.isPlayoffs=false;
    }
  } else {
    // Regular season
    S.schedule[S.week-1].result=won?'W':'L';
    S.schedule[S.week-1].myScore=hs;
    S.schedule[S.week-1].oppScore=as;
    if(won)S.wins++;else S.losses++;
    simulateOtherGames();
    S.week++;
    // Check end of regular season
    if(S.week>13){
      if(S.wins>=7){
        S.isPlayoffs=true;
        S.playoffRound=0;
      }
    }
  }
  saveGame();
  showScreen('postGame');
  renderPostGame(won,hs,as,earned,injuries);
}

function renderPostGame(won,hs,as,earned,injuries){
  const el=document.getElementById('postGameContent');
  const t=TEAMS[S.teamIdx];
  let h='<div style="text-align:center;padding:20px">';
  h+=`<div class="pg-score" style="color:${won?'#2ecc71':'#e74c3c'}">${hs} - ${as}</div>`;
  h+=`<div class="pg-result" style="color:${won?'#2ecc71':'#e74c3c'}">${won?'VICTORY!':'DEFEAT'}</div>`;
  h+=`<div style="margin:10px 0"><span class="gold">+${earned} credits</span></div>`;
  h+=`<div class="secondary">Fans: ${S.fans}%</div>`;
  if(injuries.length>0){
    h+=`<div style="color:#e74c3c;margin:8px 0;font-size:13px">Injuries: ${injuries.join(', ')}</div>`;
  }
  // Check special states
  if(S.isPlayoffs&&S.playoffRound>=3){
    // Just won championship (already incremented)
    // Actually this case is handled above - if playoffRound>=3 we set isPlayoffs=false
  }
  if(!S.isPlayoffs&&S.playoffRound>=3){
    h+=`<div style="font-size:24px;color:#f0c040;margin:10px 0;font-weight:bold">CHAMPION!</div>`;
    h+=`<div class="secondary">You won the championship!</div>`;
  }
  if(!S.isPlayoffs&&S.week>13&&S.wins<7){
    h+=`<div class="secondary" style="margin:8px 0">Season over - did not qualify for playoffs.</div>`;
  }
  h+=`<button class="btn btn-green" style="font-size:16px;padding:12px 30px;margin-top:16px" onclick="continueAfterGame()">CONTINUE</button>`;
  h+='</div>';
  el.innerHTML=h;
}

function continueAfterGame(){
  if(S.isPlayoffs){
    // More playoff games
    showScreen('home');renderHome();
  } else if(S.week>13||S.playoffRound>=3){
    // Season over - go to draft
    showScreen('home');renderHome();
  } else {
    showScreen('home');renderHome();
  }
}

// === START GAME ===
function startGame(){
  setGameConstants();
  inGame=true;
  showScreen('game');
  // Determine opponent difficulty
  let oppDiff=3;
  if(S.isPlayoffs){
    oppDiff=3+S.playoffRound; // playoffs get harder
  } else if(S.week<=13){
    oppDiff=TEAMS[S.schedule[S.week-1].oppIdx].diff;
  }
  currentOppDiff=oppDiff;
  resetForManagement();
}

let currentOppDiff=3;

function resetForManagement(){
  initGame();
  G.ph='pp';G.pos='h';
  showPM();
}

// =============================================
// === GAME ENGINE ===
// =============================================
const C = document.getElementById('c'), X = C.getContext('2d');
const pm = document.getElementById('pm');
const msgEl = document.getElementById('msg');
const sH = document.getElementById('sH'), sI = document.getElementById('sI'), sA = document.getElementById('sA');
const W = 800, H = 600, YPX = H / 12, PR = 10;

// === CONSTANTS (non-roster-affected stay const) ===
const SACK_R = 16, TACKLE_R = 16;
const STAM_DRAIN = 1.5, STAM_REGEN = 0.5;
const DEF_MAN_RATIO = 0.92;
const JUKE_CD = 18, JUKE_DIST = 32;
const MAX_POWER = 320, MIN_POWER = 35;
const PPQ = 5;
const INT_R = 20;

// === PERSPECTIVE CONSTANTS ===
const HORIZON_Y = 75;
const GROUND_Y = 590;
const NEAR_HALF_W = 440;
const FAR_HALF_W = 95;
const PERSP_POW = 0.72;
const WORLD_TOP = YPX;
const WORLD_BOT = H - YPX;
let camWY = 300;

// === COLORS ===
const FG1 = '#2d8a4e', FG2 = '#278a45', EZA = '#1a5276', EZB = '#922b21';
let HCOL = '#2980b9', ACOL = '#c0392b';
const OLCOL = '#1a6fa0';

// === ROUTES ===
const R = {
  streak: t=>({dx:0,dy:-t*3.4}),
  slant: t=>({dx:t<18?0:(t-18)*2.4,dy:-t*2.9}),
  slantL: t=>({dx:t<18?0:-(t-18)*2.4,dy:-t*2.9}),
  out: t=>({dx:t<22?0:(t-22)*3.2,dy:t<22?-t*2.8:-62}),
  outL: t=>({dx:t<22?0:-(t-22)*3.2,dy:t<22?-t*2.8:-62}),
  post: t=>({dx:t<22?0:-(t-22)*1.4,dy:-t*3.1}),
  postR: t=>({dx:t<22?0:(t-22)*1.4,dy:-t*3.1}),
  curl: t=>({dx:0,dy:t<28?-t*2.8:-78+(t-28)*1.2}),
  flat: t=>({dx:t*3.2,dy:t<10?-t*1.4:-14}),
  flatL: t=>({dx:-t*3.2,dy:t<10?-t*1.4:-14}),
  block: t=>({dx:0,dy:-Math.min(t*1.2,18)}),
};

// === PLAYS ===
const OPLAYS = [
  {name:'Short Pass',type:'pass',routes:['slant','out','flat'],color:'#3498db'},
  {name:'Deep Pass',type:'pass',routes:['streak','post','slantL'],color:'#9b59b6'},
  {name:'Spread',type:'pass',routes:['outL','curl','postR'],color:'#e67e22'},
  {name:'HB Draw',type:'run',routes:['block','block','block'],color:'#27ae60'},
  {name:'QB Scramble',type:'scramble',routes:['streak','slant','flat'],color:'#f39c12'},
];
const DPLAYS = [
  {name:'Man Coverage',scheme:'man',aggr:0.92,blitz:0,color:'#e74c3c'},
  {name:'Zone Defense',scheme:'zone',aggr:0.7,blitz:0,color:'#c0392b'},
  {name:'Blitz',scheme:'man',aggr:0.85,blitz:2,color:'#8e44ad'},
  {name:'Prevent',scheme:'zone',aggr:0.5,blitz:0,color:'#2c3e50'},
];
const AI_PLAYS = [
  {routes:['slant','out','flat']},
  {routes:['streak','post','slantL']},
  {routes:['outL','curl','postR']},
  {routes:['flatL','curl','flat']},
];

// === STATE ===
let G={},P=[],ball={},parts=[],curOP=null,curDP=null;
const keys={};
window.addEventListener('keydown',e=>{keys[e.key.toLowerCase()]=true;if(['arrowup','arrowdown','arrowleft','arrowright',' '].includes(e.key.toLowerCase()))e.preventDefault();});
window.addEventListener('keyup',e=>keys[e.key.toLowerCase()]=false);

// === TOUCH CONTROLS (iPad/Mobile) ===
const isTouchDevice='ontouchstart' in window||navigator.maxTouchPoints>0;
function initTouchControls(){
  if(!isTouchDevice)return;
  document.querySelectorAll('#dpad .dp[data-key], #actBtns .ab[data-key]').forEach(btn=>{
    const k=btn.getAttribute('data-key');
    btn.addEventListener('touchstart',e=>{e.preventDefault();e.stopPropagation();keys[k]=true;btn.classList.add('pressed');},{passive:false});
    btn.addEventListener('touchend',e=>{e.preventDefault();e.stopPropagation();keys[k]=false;btn.classList.remove('pressed');},{passive:false});
    btn.addEventListener('touchcancel',e=>{keys[k]=false;btn.classList.remove('pressed');});
  });
}
function showTouchControls(show){
  const el=document.getElementById('touchControls');
  if(!el||!isTouchDevice)return;
  if(show)el.classList.add('show');else el.classList.remove('show');
}

// === PERSPECTIVE PROJECTION (ENDZONE CAMERA) ===
function project(wx, wy) {
  const t = clamp((WORLD_BOT - wy) / (WORLD_BOT - WORLD_TOP), 0, 1);
  const pt = Math.pow(t, PERSP_POW);
  const halfW = NEAR_HALF_W + (FAR_HALF_W - NEAR_HALF_W) * pt;
  const scale = halfW / NEAR_HALF_W;
  const relX = (wx - W / 2) / (W / 2);
  const sx = W / 2 + relX * halfW;
  const sy = GROUND_Y - pt * (GROUND_Y - HORIZON_Y);
  return { x: sx, y: sy, s: scale };
}

function unproject(sx, sy) {
  const pt = clamp((GROUND_Y - sy) / (GROUND_Y - HORIZON_Y), 0, 1);
  const t = Math.pow(pt, 1 / PERSP_POW);
  const halfW = NEAR_HALF_W + (FAR_HALF_W - NEAR_HALF_W) * pt;
  const relX = halfW > 0 ? (sx - W / 2) / halfW : 0;
  const wx = W / 2 + relX * (W / 2);
  const wy = WORLD_BOT - t * (WORLD_BOT - WORLD_TOP);
  return { x: wx, y: wy };
}

function wy2yd(wy) {
  return (H - wy - YPX) / (H - 2 * YPX) * 100;
}

// Mouse
let drag={active:false,sx:0,sy:0,cx:0,cy:0};
C.addEventListener('mousedown',e=>{
  if(G.ph!=='live'||!curOP||curOP.type==='run')return;
  const r=C.getBoundingClientRect();
  drag.sx=(e.clientX-r.left)*(W/r.width);drag.sy=(e.clientY-r.top)*(H/r.height);
  drag.cx=drag.sx;drag.cy=drag.sy;drag.active=true;
});
C.addEventListener('mousemove',e=>{
  if(!drag.active)return;
  const r=C.getBoundingClientRect();
  drag.cx=(e.clientX-r.left)*(W/r.width);drag.cy=(e.clientY-r.top)*(H/r.height);
});
C.addEventListener('mouseup',e=>{
  if(!drag.active){drag.active=false;return;}
  drag.active=false;
  if(G.ph!=='live')return;
  const r=C.getBoundingClientRect();
  const ex=(e.clientX-r.left)*(W/r.width),ey=(e.clientY-r.top)*(H/r.height);
  const sdx=drag.sx-ex,sdy=drag.sy-ey;
  const power=Math.hypot(sdx,sdy);
  if(power<MIN_POWER)return;
  const qb=P.find(p=>p.team==='h'&&p.role==='qb');
  if(!qb||!qb.hb)return;
  const qbS=project(qb.x,qb.y);
  const snx=sdx/power,sny=sdy/power;
  const dist=Math.min(power,MAX_POWER);
  const stx=qbS.x+snx*dist,sty=qbS.y+sny*dist;
  const wt=unproject(stx,sty);
  const wdx=wt.x-qb.x,wdy=wt.y-qb.y;
  doThrow(qb,wdx,wdy,Math.hypot(wdx,wdy));
});
// Touch
C.addEventListener('touchstart',e=>{e.preventDefault();
  if(G.ph!=='live'||!curOP||curOP.type==='run')return;
  const t=e.touches[0],r=C.getBoundingClientRect();
  drag.sx=(t.clientX-r.left)*(W/r.width);drag.sy=(t.clientY-r.top)*(H/r.height);
  drag.cx=drag.sx;drag.cy=drag.sy;drag.active=true;
},{passive:false});
C.addEventListener('touchmove',e=>{e.preventDefault();
  if(!drag.active)return;const t=e.touches[0],r=C.getBoundingClientRect();
  drag.cx=(t.clientX-r.left)*(W/r.width);drag.cy=(t.clientY-r.top)*(H/r.height);
},{passive:false});
C.addEventListener('touchend',e=>{e.preventDefault();
  if(!drag.active){drag.active=false;return;}drag.active=false;
  if(G.ph!=='live')return;
  const sdx=drag.sx-drag.cx,sdy=drag.sy-drag.cy;const power=Math.hypot(sdx,sdy);
  if(power<MIN_POWER)return;
  const qb=P.find(p=>p.team==='h'&&p.role==='qb');if(!qb||!qb.hb)return;
  const qbS=project(qb.x,qb.y);
  const snx=sdx/power,sny=sdy/power;
  const dist=Math.min(power,MAX_POWER);
  const stx=qbS.x+snx*dist,sty=qbS.y+sny*dist;
  const wt=unproject(stx,sty);
  const wdx=wt.x-qb.x,wdy=wt.y-qb.y;
  doThrow(qb,wdx,wdy,Math.hypot(wdx,wdy));
},{passive:false});

function executeThrow(qb,ddx,ddy,power){
  const dist=Math.min(power,MAX_POWER);const mag=Math.hypot(ddx,ddy);
  const nx=ddx/mag,ny=ddy/mag;
  let scatter=0;
  P.filter(p=>p.team==='a'&&p.role==='dl').forEach(d=>{
    const dd=Math.hypot(d.x-qb.x,d.y-qb.y);scatter=Math.max(scatter,Math.max(0,1-dd/90)*35);
  });
  const ox=(Math.random()-0.5)*scatter,oy=(Math.random()-0.5)*scatter;
  ball.sx=qb.x;ball.sy=qb.y;
  ball.tx=clamp(qb.x+nx*dist+ox,20,W-20);ball.ty=clamp(qb.y+ny*dist+oy,YPX,H-YPX);
  ball.x=qb.x;ball.y=qb.y;ball.air=true;ball.t=0;
  const fd=Math.hypot(ball.tx-qb.x,ball.ty-qb.y);
  ball.tt=Math.max(10,fd/gBALL_SPD);ball.arc=fd*0.12;
  qb.hb=false;
  const recs=P.filter(p=>p.team==='h'&&p.role==='wr');
  let best=null,bd=Infinity;
  for(const rc of recs){
    const rt=R[rc.route];if(!rt)continue;
    const ft=G.clk+ball.tt;const off=rt(ft);
    const fx=clamp(rc.sx+off.dx,15,W-15),fy=clamp(rc.sy+off.dy,YPX+5,H-YPX-5);
    const d=Math.hypot(fx-ball.tx,fy-ball.ty);
    if(d<bd){bd=d;best=rc;}
  }
  G.target=best;
}

function doThrow(qb,ddx,ddy,power){
  G.throwAnim=12;G.throwPlayer=qb;
  G.throwPending={qb,ddx,ddy,power};
  G.ph='bia';
}

// === INIT ===
function initGame(){
  // Set team colors
  const team=TEAMS[S.teamIdx];
  HCOL=team.c1;
  const oppIdx=S.isPlayoffs?Math.floor(Math.random()*TEAMS.length):
    (S.week<=13?S.schedule[S.week-1].oppIdx:0);
  if(oppIdx!==S.teamIdx){ACOL=TEAMS[oppIdx].c1;}else{ACOL='#c0392b';}

  G={hs:0,as:0,q:1,mq:4,pos:'h',dn:1,ytg:10,los:25,ph:'title',
     clk:0,st:0,pr:'',ppq:0,target:null,carrier:null,
     stam:gSTAM_MAX,sprint:false,jcd:0,aiTF:0,
     throwAnim:0,throwPlayer:null,throwPending:null,
     catchAnim:0,catchPlayer:null,
     tackleAnim:0,tackleRunner:null,tackleDef:null,pendingEndPlay:''};
  updSB();
}

// === YARD <-> Y ===
function y2y(yd){return H-(yd/100)*(H-2*YPX)-YPX;}

// === FIELD (3D PERSPECTIVE) ===
function drawField(){
  X.fillStyle='#0d0d1a';
  X.fillRect(0,0,W,H);
  const skyG=X.createLinearGradient(0,0,0,HORIZON_Y+15);
  skyG.addColorStop(0,'#0a0a18');
  skyG.addColorStop(1,'#141428');
  X.fillStyle=skyG;
  X.fillRect(0,0,W,HORIZON_Y+15);
  drawCrowd();
  const STRIPS=28;
  const stripH=(WORLD_BOT-WORLD_TOP)/STRIPS;
  for(let i=0;i<STRIPS;i++){
    const wyNear=WORLD_BOT-i*stripH;
    const wyFar=WORLD_BOT-(i+1)*stripH;
    const pNL=project(0,wyNear),pNR=project(W,wyNear);
    const pFL=project(0,wyFar),pFR=project(W,wyFar);
    const ydNear=wy2yd(wyNear),ydFar=wy2yd(wyFar);
    let col;
    if(ydNear<0||ydFar<0) col=EZB;
    else if(ydNear>100||ydFar>100) col=EZA;
    else col=i%2===0?FG1:FG2;
    X.fillStyle=col;
    X.beginPath();
    X.moveTo(pNL.x,pNL.y);X.lineTo(pNR.x,pNR.y);
    X.lineTo(pFR.x,pFR.y);X.lineTo(pFL.x,pFL.y);
    X.closePath();X.fill();
  }
  const ezTopWY=y2y(95);const pEZT=project(W/2,ezTopWY);
  const ezFs=Math.max(7,Math.round(18*pEZT.s));
  X.fillStyle='rgba(255,255,255,0.3)';X.font=`bold ${ezFs}px sans-serif`;X.textAlign='center';
  X.fillText('E N D Z O N E',pEZT.x,pEZT.y);
  const ezBotWY=y2y(5);const pEZB=project(W/2,ezBotWY);
  const ezBFs=Math.max(8,Math.round(18*pEZB.s));
  X.font=`bold ${ezBFs}px sans-serif`;
  X.fillText('E N D Z O N E',pEZB.x,pEZB.y);
  X.strokeStyle='rgba(255,255,255,0.5)';X.lineWidth=2;
  const slBotL=project(0,WORLD_BOT+10),slBotR=project(W,WORLD_BOT+10);
  const slTopL=project(0,WORLD_TOP-10),slTopR=project(W,WORLD_TOP-10);
  X.beginPath();X.moveTo(slBotL.x,slBotL.y);X.lineTo(slTopL.x,slTopL.y);X.stroke();
  X.beginPath();X.moveTo(slBotR.x,slBotR.y);X.lineTo(slTopR.x,slTopR.y);X.stroke();
  for(let yd=10;yd<=90;yd+=10){
    const wy=y2y(yd);
    const pL=project(40,wy),pR=project(W-40,wy);
    X.strokeStyle='rgba(255,255,255,0.4)';
    X.lineWidth=Math.max(0.5,1.5*pL.s);
    X.beginPath();X.moveTo(pL.x,pL.y);X.lineTo(pR.x,pR.y);X.stroke();
  }
  for(let yd=5;yd<=95;yd+=5){
    if(yd%10===0)continue;
    const wy=y2y(yd);
    const pL1=project(35,wy),pL2=project(50,wy);
    const pR1=project(W-35,wy),pR2=project(W-50,wy);
    X.strokeStyle='rgba(255,255,255,0.2)';
    X.lineWidth=Math.max(0.5,1*pL1.s);
    X.beginPath();X.moveTo(pL1.x,pL1.y);X.lineTo(pL2.x,pL2.y);X.stroke();
    X.beginPath();X.moveTo(pR1.x,pR1.y);X.lineTo(pR2.x,pR2.y);X.stroke();
  }
  X.fillStyle='rgba(255,255,255,0.3)';
  for(let yd=10;yd<=90;yd+=10){
    const label=yd<=50?yd:100-yd;
    const wy=y2y(yd);
    const pL=project(22,wy),pR=project(W-22,wy);
    const fs=Math.max(5,Math.round(14*pL.s));
    X.font=`bold ${fs}px sans-serif`;X.textAlign='center';
    X.fillText(label,pL.x,pL.y+fs*0.35);
    X.fillText(label,pR.x,pR.y+fs*0.35);
  }
  const losWY=y2y(G.los);
  const losL=project(0,losWY),losR=project(W,losWY);
  X.strokeStyle='#f1c40f';X.lineWidth=Math.max(1,2.5*losL.s);X.setLineDash([6,4]);
  X.beginPath();X.moveTo(losL.x,losL.y);X.lineTo(losR.x,losR.y);X.stroke();X.setLineDash([]);
  const fdv=Math.min(100,G.los+G.ytg);
  if(fdv<=100){
    const fdWY=y2y(fdv);
    const fdL=project(0,fdWY),fdR=project(W,fdWY);
    X.strokeStyle='#e74c3c';X.lineWidth=Math.max(1,2.5*fdL.s);X.setLineDash([6,4]);
    X.beginPath();X.moveTo(fdL.x,fdL.y);X.lineTo(fdR.x,fdR.y);X.stroke();X.setLineDash([]);
    const arSz=Math.max(3,7*fdL.s);
    X.fillStyle='#e74c3c';
    X.beginPath();X.moveTo(fdL.x+2,fdL.y);X.lineTo(fdL.x+2+arSz*1.3,fdL.y-arSz);X.lineTo(fdL.x+2+arSz*1.3,fdL.y+arSz);X.fill();
    X.beginPath();X.moveTo(fdR.x-2,fdR.y);X.lineTo(fdR.x-2-arSz*1.3,fdR.y-arSz);X.lineTo(fdR.x-2-arSz*1.3,fdR.y+arSz);X.fill();
  }
}

function drawCrowd(){
  const colors=['#553322','#442211','#332211','#664433','#443322','#554422','#663344','#225566'];
  const seed=42;
  for(let row=0;row<18;row++){
    const t=row/18;
    const pt=Math.pow(t,PERSP_POW);
    const halfW=NEAR_HALF_W+(FAR_HALF_W-NEAR_HALF_W)*pt;
    const sy=GROUND_Y-pt*(GROUND_Y-HORIZON_Y);
    const cx=W/2;
    const leftEdge=cx-halfW;
    const rightEdge=cx+halfW;
    const s=Math.max(2,5*(1-pt));
    for(let j=0;j<6;j++){
      const x=leftEdge-8-j*s*1.3;
      if(x<0)continue;
      const ci=(row*7+j*13+seed)%colors.length;
      X.fillStyle=colors[ci];
      X.fillRect(x-s/2,sy-s/2,s,s*0.8);
    }
    for(let j=0;j<6;j++){
      const x=rightEdge+8+j*s*1.3;
      if(x>W)continue;
      const ci=(row*11+j*7+seed)%colors.length;
      X.fillStyle=colors[ci];
      X.fillRect(x-s/2,sy-s/2,s,s*0.8);
    }
  }
}

// === PLAY MENU ===
function showPM(){
  pm.innerHTML='';const t=document.createElement('h3');
  if(G.pos==='h'){
    t.textContent='OFFENSE';pm.appendChild(t);
    OPLAYS.forEach((p,i)=>{const b=document.createElement('button');
      b.textContent=p.name;b.style.background=p.color;
      b.addEventListener('click',()=>selOff(i));pm.appendChild(b);});
  } else {
    t.textContent='DEFENSE';pm.appendChild(t);
    DPLAYS.forEach((p,i)=>{const b=document.createElement('button');
      b.textContent=p.name;b.style.background=p.color;
      b.addEventListener('click',()=>selDef(i));pm.appendChild(b);});
  }
  pm.classList.add('show');G.ph='pp';
}

function selOff(i){
  curOP=OPLAYS[i];curDP=DPLAYS[Math.floor(Math.random()*DPLAYS.length)];
  pm.classList.remove('show');
  setupOff();setupAIDef();assignDef();
  G.ph='pre';G.clk=0;
  ball={x:W/2,y:y2y(G.los),air:false,sx:0,sy:0,tx:0,ty:0,tt:0,t:0,arc:0};
  showDefenseRoll(curDP,()=>{if(G.ph==='pre'){G.ph=curOP.type==='run'?'run':curOP.type==='scramble'?'run':'live';G.clk=0;}});
}
function selDef(i){
  curDP=DPLAYS[i];pm.classList.remove('show');
  setupAIOff();setupPlayerDef();assignPlayerDef();
  G.ph='pre';G.clk=0;G.aiTF=50+Math.floor(Math.random()*25);
  ball={x:W/2,y:y2y(G.los),air:false,sx:0,sy:0,tx:0,ty:0,tt:0,t:0,arc:0};
  showDefenseConfirm(curDP,()=>{if(G.ph==='pre'){G.ph='dl';G.clk=0;}});
}

// === SETUP PLAYER OFFENSE ===
function setupOff(){
  P=[];const ly=y2y(G.los);
  P.push({team:'h',role:'qb',x:W/2,y:ly+40,sx:W/2,sy:ly+40,n:7,col:HCOL,hb:true,px:W/2,py:ly+40,anim:0});
  for(let i=0;i<5;i++){const ox=W/2+(i-2)*26;
    P.push({team:'h',role:'ol',x:ox,y:ly+5,sx:ox,sy:ly+5,n:70+i,col:OLCOL,hb:false,bdt:0,px:ox,py:ly+5,anim:0});}
  const rp=[{x:W/2-180,y:ly-2},{x:W/2+180,y:ly-2},{x:W/2-70,y:ly+18}];
  const rn=[81,88,32];
  for(let i=0;i<curOP.routes.length;i++){
    P.push({team:'h',role:'wr',x:rp[i].x,y:rp[i].y,sx:rp[i].x,sy:rp[i].y,
      n:rn[i],col:HCOL,route:curOP.routes[i],hb:false,caught:false,px:rp[i].x,py:rp[i].y,anim:0});}
  if(curOP.type==='run'){
    P.push({team:'h',role:'rb',x:W/2,y:ly+55,sx:W/2,sy:ly+55,n:28,col:HCOL,hb:false,px:W/2,py:ly+55,anim:0});}
}

function setupAIDef(){
  const ly=y2y(G.los);
  const dp=[
    {x:W/2-155,y:ly-35,role:'cb',n:21},{x:W/2+155,y:ly-35,role:'cb',n:24},
    {x:W/2-40,y:ly-18,role:'lb',n:55},{x:W/2+40,y:ly-18,role:'lb',n:52},
    {x:W/2,y:ly-80,role:'sf',n:31},
    {x:W/2-30,y:ly-3,role:'dl',n:91},{x:W/2,y:ly-3,role:'dl',n:95},{x:W/2+30,y:ly-3,role:'dl',n:97},
  ];
  dp.forEach(d=>P.push({team:'a',role:d.role,x:d.x,y:d.y,sx:d.x,sy:d.y,n:d.n,col:ACOL,hb:false,ar:null,zone:null,bdt:0,px:d.x,py:d.y,anim:0}));
}

function setupAIOff(){
  P=[];const ly=y2y(G.los);
  const aip=AI_PLAYS[Math.floor(Math.random()*AI_PLAYS.length)];
  P.push({team:'a',role:'qb',x:W/2,y:ly-35,sx:W/2,sy:ly-35,n:10,col:ACOL,hb:true,ai:true,px:W/2,py:ly-35,anim:0});
  for(let i=0;i<5;i++){const ox=W/2+(i-2)*26;
    P.push({team:'a',role:'ol',x:ox,y:ly-5,sx:ox,sy:ly-5,n:70+i,col:'#a93226',hb:false,ai:true,bdt:0,px:ox,py:ly-5,anim:0});}
  const rp=[{x:W/2-160,y:ly},{x:W/2+160,y:ly},{x:W/2-55,y:ly-10}];
  const rn=[80,87,83];
  for(let i=0;i<aip.routes.length;i++){
    P.push({team:'a',role:'wr',x:rp[i].x,y:rp[i].y,sx:rp[i].x,sy:rp[i].y,
      n:rn[i],col:ACOL,route:aip.routes[i],hb:false,caught:false,ai:true,px:rp[i].x,py:rp[i].y,anim:0});}
}

function setupPlayerDef(){
  const ly=y2y(G.los);
  // Find roster defensive players
  const rCBs=S.roster.filter(p=>p.pos==='CB');
  const rLBs=S.roster.filter(p=>p.pos==='LB');
  const rSFs=S.roster.filter(p=>p.pos==='SF');
  const rDLs=S.roster.filter(p=>p.pos==='DL');
  // Default stats for fallback
  const defStats={spd:55,str:55};
  const dp=[
    {x:W/2-140,y:ly+35,role:'cb',n:21,rs:rCBs[0]?rCBs[0].stats:defStats},
    {x:W/2+140,y:ly+35,role:'cb',n:24,rs:rCBs[1]?rCBs[1].stats:defStats},
    {x:W/2-45,y:ly+12,role:'lb',n:55,rs:rLBs[0]?rLBs[0].stats:defStats},
    {x:W/2+45,y:ly+12,role:'lb',n:52,rs:rLBs[1]?rLBs[1].stats:defStats},
    {x:W/2,y:ly+65,role:'sf',n:31,rs:rSFs[0]?rSFs[0].stats:defStats},
    {x:W/2-25,y:ly+4,role:'dl',n:91,rs:rDLs[0]?rDLs[0].stats:defStats},
    {x:W/2+25,y:ly+4,role:'dl',n:97,rs:rDLs.length>1?rDLs[1].stats:(rDLs[0]?rDLs[0].stats:defStats)},
  ];
  dp.forEach(d=>P.push({team:'h',role:d.role,x:d.x,y:d.y,sx:d.x,sy:d.y,n:d.n,col:HCOL,hb:false,ar:null,zone:null,aiD:true,bdt:0,px:d.x,py:d.y,anim:0,rs:d.rs}));
}

function assignDef(){
  const wrs=P.filter(p=>p.team==='h'&&p.role==='wr');
  const defs=P.filter(p=>p.team==='a'&&['cb','lb','sf'].includes(p.role));
  if(curDP.scheme==='man'){
    for(let i=0;i<defs.length&&i<wrs.length;i++)defs[i].ar=wrs[i];
    for(let i=wrs.length;i<defs.length;i++){const ly=y2y(G.los);defs[i].zone={x:W/2,y:ly-60,r:120};}
  } else {
    const ly=y2y(G.los);
    const zones=[{x:W*0.2,y:ly-55,r:95},{x:W*0.8,y:ly-55,r:95},{x:W*0.4,y:ly-35,r:75},
      {x:W*0.6,y:ly-35,r:75},{x:W*0.5,y:ly-110,r:120}];
    for(let i=0;i<defs.length;i++)defs[i].zone=zones[i%zones.length];
  }
}
function assignPlayerDef(){
  const wrs=P.filter(p=>p.team==='a'&&p.role==='wr');
  const defs=P.filter(p=>p.team==='h'&&['cb','lb','sf'].includes(p.role));
  if(curDP.scheme==='man'){
    for(let i=0;i<defs.length&&i<wrs.length;i++)defs[i].ar=wrs[i];
    for(let i=wrs.length;i<defs.length;i++){const ly=y2y(G.los);defs[i].zone={x:W/2,y:ly+60,r:120};}
  } else {
    const ly=y2y(G.los);
    const zones=[{x:W*0.2,y:ly+55,r:95},{x:W*0.8,y:ly+55,r:95},{x:W*0.4,y:ly+35,r:75},
      {x:W*0.6,y:ly+35,r:75},{x:W*0.5,y:ly+110,r:120}];
    for(let i=0;i<defs.length;i++)defs[i].zone=zones[i%zones.length];
  }
}

// === UPDATE FUNCTIONS ===

function updLive(){
  G.clk++;
  const qb=P.find(p=>p.team==='h'&&p.role==='qb');
  if(qb&&qb.hb){
    let dx=0,dy=0;
    if(keys['arrowleft']||keys['a'])dx-=1;if(keys['arrowright']||keys['d'])dx+=1;
    if(keys['arrowup']||keys['w'])dy-=1;if(keys['arrowdown']||keys['s'])dy+=1;
    if(dx&&dy){dx*=0.707;dy*=0.707;}
    qb.x+=dx*gQB_SPD;qb.y+=dy*gQB_SPD;
    qb.x=clamp(qb.x,20,W-20);qb.y=clamp(qb.y,YPX,H-YPX);
    ball.x=qb.x;ball.y=qb.y;
  }
  P.filter(p=>p.team==='h'&&p.role==='wr').forEach(wr=>{
    if(wr.caught)return;const rt=R[wr.route];if(!rt)return;
    const o=rt(G.clk);wr.x=clamp(wr.sx+o.dx,15,W-15);wr.y=clamp(wr.sy+o.dy,YPX+5,H-YPX-5);
  });
  updOLBlock('h','a');
  updAIDef(qb);
  if(qb&&qb.hb){for(const d of P.filter(p=>p.team==='a'&&p.role==='dl')){
    if(Math.hypot(d.x-qb.x,d.y-qb.y)<SACK_R){mkP(qb.x,qb.y,'#e74c3c',15);G.tackleAnim=20;G.tackleRunner=qb;G.tackleDef=d;G.pendingEndPlay='sack';G.ph='tackle';return;}}}
  if(G.clk>200&&qb&&qb.hb){
    const recs=P.filter(p=>p.team==='h'&&p.role==='wr');
    if(recs.length>0){const t=recs[Math.floor(Math.random()*recs.length)];
      const ddx=t.x-qb.x,ddy=t.y-qb.y;doThrow(qb,ddx,ddy,Math.hypot(ddx,ddy));}}
}

function updBIA(){
  G.clk++;
  if(!ball.air)return;
  ball.t++;
  const pr=Math.min(1,ball.t/ball.tt);
  ball.x=ball.sx+(ball.tx-ball.sx)*pr;ball.y=ball.sy+(ball.ty-ball.sy)*pr;
  ball.ao=-ball.arc*4*pr*(1-pr);
  P.filter(p=>p.team==='h'&&p.role==='wr').forEach(wr=>{
    if(wr.caught)return;const rt=R[wr.route];if(!rt)return;
    const o=rt(G.clk);wr.x=clamp(wr.sx+o.dx,15,W-15);wr.y=clamp(wr.sy+o.dy,YPX+5,H-YPX-5);
  });
  const dp=curDP||DPLAYS[0];
  P.filter(p=>p.team==='a').forEach(d=>{
    if(d.role==='sf'&&ball.air){
      const bx=ball.tx-d.x,by=ball.ty-d.y,bd=Math.hypot(bx,by);
      if(bd>5){d.x+=bx/bd*3.2;d.y+=by/bd*3.2;}
    } else if(d.ar){
      const rx=d.ar.x-d.x,ry=d.ar.y-d.y,rd=Math.hypot(rx,ry);
      if(rd>3){d.x+=rx/rd*2.6;d.y+=ry/rd*2.6;}
    }
    d.x=clamp(d.x,15,W-15);d.y=clamp(d.y,YPX+5,H-YPX-5);
  });
  if(pr>=1)resolveCatch('h','a');
}

function resolveCatch(offT,defT){
  const tgt=G.target;
  const dtgt=tgt?Math.hypot(tgt.x-ball.tx,tgt.y-ball.ty):Infinity;
  for(const d of P.filter(p=>p.team===defT)){
    const dd=Math.hypot(d.x-ball.tx,d.y-ball.ty);
    if(dd<INT_R){
      const ic=dtgt>gCATCH_R?0.75:dd<dtgt?0.35:0.12;
      if(Math.random()<ic){mkP(ball.tx,ball.ty,'#e74c3c',20);showMsg('INTERCEPTED!');
        endPlay(offT==='h'?'int':'dInt');return;}
    }
  }
  if(tgt&&dtgt<gCATCH_R){
    tgt.caught=true;tgt.hb=true;ball.air=false;
    G.carrier=tgt;G.stam=gSTAM_MAX;G.jcd=0;
    G.catchAnim=10;G.catchPlayer=tgt;
    mkP(tgt.x,tgt.y,'#2ecc71',12);
    G.ph=offT==='h'?'rac':'drac';
  } else {
    ball.air=false;mkP(ball.tx,ball.ty,'#95a5a6',10);showMsg('INCOMPLETE');
    endPlay(offT==='h'?'inc':'dInc');
  }
}

function updRAC(){
  G.clk++;const c=G.carrier;if(!c)return;
  let dx=0,dy=0;
  if(keys['arrowleft']||keys['a'])dx-=1;if(keys['arrowright']||keys['d'])dx+=1;
  if(keys['arrowup']||keys['w'])dy-=1;if(keys['arrowdown']||keys['s'])dy+=1;
  if(dx&&dy){dx*=0.707;dy*=0.707;}
  G.sprint=keys[' ']&&G.stam>0;
  if(G.sprint)G.stam=Math.max(0,G.stam-STAM_DRAIN);else G.stam=Math.min(gSTAM_MAX,G.stam+STAM_REGEN);
  const spd=G.sprint?gSPRINT_SPD:gCARRIER_SPD;
  if(dx===0&&dy===0)dy=-0.4;
  c.x+=dx*spd;c.y+=dy*spd;
  if(G.jcd>0)G.jcd--;
  if(G.jcd===0&&keys['q']){c.x-=JUKE_DIST;G.jcd=JUKE_CD;mkP(c.x+JUKE_DIST,c.y,'#f1c40f',5);}
  if(G.jcd===0&&keys['e']){c.x+=JUKE_DIST;G.jcd=JUKE_CD;mkP(c.x-JUKE_DIST,c.y,'#f1c40f',5);}
  c.x=clamp(c.x,20,W-20);c.y=clamp(c.y,YPX,H-YPX);
  ball.x=c.x;ball.y=c.y;ball.air=false;
  if(c.y<=YPX){mkP(c.x,c.y,'#f1c40f',30);showMsg('TOUCHDOWN!',2000);endPlay('td');return;}
  P.filter(p=>p.team==='a').forEach(d=>{
    const ddx=c.x-d.x,ddy=c.y-d.y,dd=Math.hypot(ddx,ddy);
    const cs=d.role==='dl'?2.2:d.role==='lb'?2.7:2.9;
    if(dd>5){d.x+=ddx/dd*cs;d.y+=ddy/dd*cs;}
    if(dd<TACKLE_R){mkP(c.x,c.y,'#e74c3c',15);G.tackleAnim=20;G.tackleRunner=c;G.tackleDef=d;G.pendingEndPlay='tkl';G.ph='tackle';}
  });
  if(G.sprint&&Math.random()<0.3)parts.push({x:c.x,y:c.y+8,vx:(Math.random()-0.5),vy:Math.random()*2,l:0.4,d:0.05,s:3,c:'rgba(255,255,255,0.3)'});
}

function updRun(){
  G.clk++;
  const qb=P.find(p=>p.team==='h'&&p.role==='qb');
  const rb=P.find(p=>p.team==='h'&&p.role==='rb');
  if(curOP.type==='scramble'){
    if(G.clk<8){ball.x=qb.x;ball.y=qb.y;return;}
    if(G.clk===8){qb.hb=true;G.carrier=qb;G.stam=gSTAM_MAX;G.jcd=0;}
  } else {
    if(G.clk<12&&rb&&qb){rb.y-=2.5;ball.x=qb.x;ball.y=qb.y;
      updOLBlock('h','a');updAIDef(qb);return;}
    if(G.clk===12&&rb){qb.hb=false;rb.hb=true;G.carrier=rb;G.stam=gSTAM_MAX;G.jcd=0;}
  }
  const c=G.carrier;if(!c)return;
  let dx=0,dy=0;
  if(keys['arrowleft']||keys['a'])dx-=1;if(keys['arrowright']||keys['d'])dx+=1;
  if(keys['arrowup']||keys['w'])dy-=1;if(keys['arrowdown']||keys['s'])dy+=1;
  if(dx&&dy){dx*=0.707;dy*=0.707;}
  G.sprint=keys[' ']&&G.stam>0;
  if(G.sprint)G.stam=Math.max(0,G.stam-STAM_DRAIN);else G.stam=Math.min(gSTAM_MAX,G.stam+STAM_REGEN);
  const spd=G.sprint?gSPRINT_SPD:gCARRIER_SPD;
  if(dx===0&&dy===0)dy=-0.5;
  c.x+=dx*spd;c.y+=dy*spd;
  if(G.jcd>0)G.jcd--;
  if(G.jcd===0&&keys['q']){c.x-=JUKE_DIST;G.jcd=JUKE_CD;mkP(c.x+JUKE_DIST,c.y,'#f1c40f',5);}
  if(G.jcd===0&&keys['e']){c.x+=JUKE_DIST;G.jcd=JUKE_CD;mkP(c.x-JUKE_DIST,c.y,'#f1c40f',5);}
  c.x=clamp(c.x,20,W-20);c.y=clamp(c.y,YPX,H-YPX);
  ball.x=c.x;ball.y=c.y;ball.air=false;
  updOLBlock('h','a');
  P.filter(p=>p.team==='a').forEach(d=>{
    const ddx=c.x-d.x,ddy=c.y-d.y,dd=Math.hypot(ddx,ddy);
    const cs=d.role==='dl'?2.2:d.role==='lb'?2.7:2.9;
    if(dd>5){d.x+=ddx/dd*cs;d.y+=ddy/dd*cs;}
    if(dd<TACKLE_R){mkP(c.x,c.y,'#e74c3c',15);G.tackleAnim=20;G.tackleRunner=c;G.tackleDef=d;G.pendingEndPlay='tkl';G.ph='tackle';}
  });
  if(c.y<=YPX){mkP(c.x,c.y,'#f1c40f',30);showMsg('TOUCHDOWN!',2000);endPlay('td');return;}
  if(G.sprint&&Math.random()<0.3)parts.push({x:c.x,y:c.y+8,vx:(Math.random()-0.5),vy:Math.random()*2,l:0.4,d:0.05,s:3,c:'rgba(255,255,255,0.3)'});
}

function updOLBlock(olT,dlT){
  const ols=P.filter(p=>p.team===olT&&p.role==='ol');
  const dls=P.filter(p=>p.team===dlT&&p.role==='dl');
  for(const ol of ols){
    let near=null,nd=Infinity;
    for(const dl of dls){const d=Math.hypot(dl.x-ol.x,dl.y-ol.y);if(d<nd){nd=d;near=dl;}}
    if(near){
      if(nd>18){const dx=near.x-ol.x,dy=near.y-ol.y,d=Math.hypot(dx,dy);
        ol.x+=dx/d*2.5;ol.y+=dy/d*2.5;}
      else {
        const qb=P.find(p=>p.team===olT&&p.role==='qb');
        if(qb){const tx=qb.x-near.x,ty=qb.y-near.y,td=Math.hypot(tx,ty);
          ol.x=near.x+tx/td*14;ol.y=near.y+ty/td*14;}
      }
    }
    ol.x=clamp(ol.x,15,W-15);ol.y=clamp(ol.y,YPX+5,H-YPX-5);
  }
}

function updAIDef(qb){
  const dp=curDP||DPLAYS[0];
  P.filter(p=>p.team==='a').forEach(d=>{
    if(d.role==='dl'){
      const ols=P.filter(p=>p.team==='h'&&p.role==='ol');
      let blocked=false;
      for(const ol of ols){if(Math.hypot(ol.x-d.x,ol.y-d.y)<22){blocked=true;break;}}
      if(blocked)d.bdt=(d.bdt||0)+1; else d.bdt=0;
      const str=blocked?Math.max(0,1-(d.bdt-gBLOCK_START)/(gBLOCK_FULL-gBLOCK_START)):0;
      if(!blocked||str<0.3){
        if(qb){const dx=qb.x-d.x,dy=qb.y-d.y,dd=Math.hypot(dx,dy);
          const sp=1.9*(1-str*0.7);if(dd>5){d.x+=dx/dd*sp;d.y+=dy/dd*sp;}}
      } else {d.x+=(Math.random()-0.5)*0.8;d.y+=(Math.random()-0.5)*0.4;}
    } else if(dp.scheme==='man'&&d.ar){
      const rx=d.ar.x-d.x,ry=d.ar.y-d.y,rd=Math.hypot(rx,ry);
      const sp=2.5*DEF_MAN_RATIO;
      if(rd>3){d.x+=rx/rd*sp;d.y+=ry/rd*sp;}
    } else if(d.zone){
      const zx=d.zone.x-d.x,zy=d.zone.y-d.y,zd=Math.hypot(zx,zy);
      if(zd>d.zone.r){d.x+=zx/zd*2.0;d.y+=zy/zd*2.0;}
      else {
        const nrs=P.filter(p=>p.team==='h'&&p.role==='wr'&&Math.hypot(p.x-d.zone.x,p.y-d.zone.y)<d.zone.r*1.5);
        if(nrs.length>0){let cl=nrs[0],cd=Infinity;
          for(const nr of nrs){const dd=Math.hypot(nr.x-d.x,nr.y-d.y);if(dd<cd){cd=dd;cl=nr;}}
          const rx=cl.x-d.x,ry=cl.y-d.y,rd=Math.hypot(rx,ry);
          if(rd>5){d.x+=rx/rd*2.2;d.y+=ry/rd*2.2;}}
      }
    }
    d.x=clamp(d.x,15,W-15);d.y=clamp(d.y,YPX+5,H-YPX-5);
  });
}

function updDL(){
  G.clk++;
  const aq=P.find(p=>p.team==='a'&&p.role==='qb');
  P.filter(p=>p.team==='a'&&p.role==='wr').forEach(wr=>{
    if(wr.caught)return;const rt=R[wr.route];if(!rt)return;
    const o=rt(G.clk);wr.x=clamp(wr.sx+o.dx,15,W-15);wr.y=clamp(wr.sy-o.dy,YPX+5,H-YPX-5);
  });
  updOLBlock('a','h');
  updPlayerDefAI();
  if(aq&&aq.hb){for(const d of P.filter(p=>p.team==='h'&&p.role==='dl')){
    if(Math.hypot(d.x-aq.x,d.y-aq.y)<SACK_R){mkP(aq.x,aq.y,'#2ecc71',15);showMsg('SACK!');endPlay('dSack');return;}}}
  if(G.clk>=G.aiTF&&aq&&aq.hb&&!ball.air){aiThrow(aq);}
  if(G.clk>G.aiTF+50&&aq&&aq.hb){
    aq.y+=2.2;aq.x+=(W/2-aq.x)*0.03;ball.x=aq.x;ball.y=aq.y;
    if(aq.y>=H-YPX){showMsg('THEY SCORED!');endPlay('dTD');return;}
    for(const d of P.filter(p=>p.team==='h')){
      if(Math.hypot(d.x-aq.x,d.y-aq.y)<TACKLE_R){showMsg('QB TACKLED!');endPlay('dTkl');return;}}
  }
}

function aiThrow(aq){
  const recs=P.filter(p=>p.team==='a'&&p.role==='wr');if(recs.length===0)return;
  let best=null,bs=-Infinity;
  for(const r of recs){
    let md=Infinity;P.filter(p=>p.team==='h').forEach(d=>{md=Math.min(md,Math.hypot(d.x-r.x,d.y-r.y));});
    const sc=md+r.y*0.01;if(sc>bs){bs=sc;best=r;}
  }
  if(!best)return;
  const rt=R[best.route];const ft=G.clk+15;const o=rt(ft);
  const lx=clamp(best.sx+o.dx,20,W-20),ly=clamp(best.sy-o.dy,YPX,H-YPX);
  aq.hb=false;G.target=best;
  ball.x=aq.x;ball.y=aq.y;ball.air=true;ball.t=0;
  ball.sx=aq.x;ball.sy=aq.y;ball.tx=lx;ball.ty=ly;
  const fd=Math.hypot(ball.tx-aq.x,ball.ty-aq.y);
  ball.tt=Math.max(12,fd/8);ball.arc=fd*0.1;
  G.ph='dbia';
}

function updDBIA(){
  G.clk++;ball.t++;
  const pr=Math.min(1,ball.t/ball.tt);
  ball.x=ball.sx+(ball.tx-ball.sx)*pr;ball.y=ball.sy+(ball.ty-ball.sy)*pr;
  ball.ao=-ball.arc*4*pr*(1-pr);
  P.filter(p=>p.team==='a'&&p.role==='wr').forEach(wr=>{
    if(wr.caught)return;const rt=R[wr.route];if(!rt)return;
    const o=rt(G.clk);wr.x=clamp(wr.sx+o.dx,15,W-15);wr.y=clamp(wr.sy-o.dy,YPX+5,H-YPX-5);
  });
  P.filter(p=>p.team==='h'&&p.aiD).forEach(d=>{
    const rspd=d.rs?d.rs.spd:55;
    const spdMul=0.7+rspd/140;
    if(d.role==='sf'&&ball.air){
      const bx=ball.tx-d.x,by=ball.ty-d.y,bd=Math.hypot(bx,by);
      if(bd>5){d.x+=bx/bd*3.0*spdMul;d.y+=by/bd*3.0*spdMul;}
    } else if(d.ar){
      const rx=d.ar.x-d.x,ry=d.ar.y-d.y,rd=Math.hypot(rx,ry);
      if(rd>3){d.x+=rx/rd*2.6*spdMul;d.y+=ry/rd*2.6*spdMul;}
    }
    d.x=clamp(d.x,15,W-15);d.y=clamp(d.y,YPX+5,H-YPX-5);
  });
  if(pr>=1)resolveCatch('a','h');
}

function updDRAC(){
  G.clk++;const c=G.carrier;if(!c)return;
  c.y+=3;c.x+=(W/2-c.x)*0.02;
  c.x=clamp(c.x,15,W-15);ball.x=c.x;ball.y=c.y;ball.air=false;
  if(c.y>=H-YPX){mkP(c.x,c.y,'#e74c3c',30);showMsg('THEY SCORED!',2000);endPlay('dTD');return;}
  P.filter(p=>p.team==='h').forEach(d=>{
    const rspd=d.rs?d.rs.spd:55;
    const spdMul=0.7+rspd/140;
    const dx=c.x-d.x,dy=c.y-d.y,dd=Math.hypot(dx,dy);
    if(dd>5){d.x+=dx/dd*2.7*spdMul;d.y+=dy/dd*2.7*spdMul;}
    if(dd<TACKLE_R){mkP(c.x,c.y,'#2ecc71',15);endPlay('dTkl');}
  });
}

function updPlayerDefAI(){
  const dp=curDP||DPLAYS[0];
  P.filter(p=>p.team==='h'&&p.aiD).forEach(d=>{
    // Use roster stats for speed scaling (default 55 if no roster player)
    const rspd=d.rs?d.rs.spd:55;
    const rstr=d.rs?d.rs.str:55;
    const spdMul=0.7+rspd/140; // 55â†’1.09, 80â†’1.27, 99â†’1.41
    if(d.role==='dl'){
      const aq=P.find(p=>p.team==='a'&&p.role==='qb');
      const ols=P.filter(p=>p.team==='a'&&p.role==='ol');
      let blocked=false;
      for(const ol of ols){if(Math.hypot(ol.x-d.x,ol.y-d.y)<22){blocked=true;break;}}
      if(blocked)d.bdt=(d.bdt||0)+1;else d.bdt=0;
      // Stronger DL breaks blocks faster
      const blockAdj=gBLOCK_START-(rstr-55)*0.3;
      const str=blocked?Math.max(0,1-(d.bdt-blockAdj)/(gBLOCK_FULL-blockAdj)):0;
      const blitzSpd=(dp.blitz>0?2.7:1.9)*spdMul;
      if(!blocked||str<0.3){
        if(aq){const dx=aq.x-d.x,dy=aq.y-d.y,dd=Math.hypot(dx,dy);
          const sp=blitzSpd*(1-str*0.7);if(dd>5){d.x+=dx/dd*sp;d.y+=dy/dd*sp;}}
      } else {d.x+=(Math.random()-0.5)*0.8;d.y+=(Math.random()-0.5)*0.4;}
    } else if(dp.scheme==='man'&&d.ar){
      const rx=d.ar.x-d.x,ry=d.ar.y-d.y,rd=Math.hypot(rx,ry);
      const sp=2.5*dp.aggr*spdMul;if(rd>3){d.x+=rx/rd*sp;d.y+=ry/rd*sp;}
    } else if(d.zone){
      const zx=d.zone.x-d.x,zy=d.zone.y-d.y,zd=Math.hypot(zx,zy);
      if(zd>d.zone.r){d.x+=zx/zd*2.0*spdMul;d.y+=zy/zd*2.0*spdMul;}
      else {
        const nrs=P.filter(p=>p.team==='a'&&p.role==='wr'&&Math.hypot(p.x-d.zone.x,p.y-d.zone.y)<d.zone.r*1.5);
        if(nrs.length>0){let cl=nrs[0],cd=Infinity;
          for(const nr of nrs){const dd=Math.hypot(nr.x-d.x,nr.y-d.y);if(dd<cd){cd=dd;cl=nr;}}
          const rx=cl.x-d.x,ry=cl.y-d.y,rd=Math.hypot(rx,ry);
          if(rd>5){d.x+=rx/rd*2.2*spdMul;d.y+=ry/rd*2.2*spdMul;}}
      }
    }
    d.x=clamp(d.x,15,W-15);d.y=clamp(d.y,YPX+5,H-YPX-5);
  });
}

// === END PLAY ===
function endPlay(r){
  G.pr=r;G.ppq++;
  if(G.pos==='h'){
    switch(r){
      case 'td':G.hs+=7;G.ph='pd';G.st=70;break;
      case 'tkl':{
        const c=G.carrier;
        if(c){const yg=Math.max(0,Math.round((y2y(G.los)-c.y)/(H/100)));
          G.los=Math.min(99,G.los+yg);G.ytg-=yg;
          if(G.ytg<=0){G.dn=1;G.ytg=10;showMsg(`1ST DOWN! +${yg} yds`);}
          else {G.dn++;showMsg(yg>0?`TACKLED +${yg} yds`:'NO GAIN');}
        } else G.dn++;
        if(G.dn>4){showMsg('TURNOVER ON DOWNS');G.ph='pd';G.st=70;}
        else {G.ph='pd';G.st=50;}break;}
      case 'sack':G.los=Math.max(1,G.los-7);G.dn++;showMsg('SACKED! -7 yds');
        G.ph='pd';G.st=G.dn>4?70:50;if(G.dn>4)showMsg('TURNOVER ON DOWNS');break;
      case 'inc':G.dn++;G.ph='pd';G.st=G.dn>4?70:50;if(G.dn>4)showMsg('TURNOVER ON DOWNS');break;
      case 'int':G.ph='pd';G.st=70;break;
    }
  } else {
    switch(r){
      case 'dTD':G.as+=7;G.ph='pd';G.st=70;break;
      case 'dTkl':{
        const c=G.carrier;
        if(c){const yg=Math.max(0,Math.round((c.y-y2y(G.los))/(H/100)));
          G.los=Math.max(1,G.los-yg);G.ytg-=yg;
          if(G.ytg<=0){G.dn=1;G.ytg=10;showMsg('FIRST DOWN (CPU)');}
          else G.dn++;
        } else G.dn++;
        if(G.dn>4){showMsg('TURNOVER ON DOWNS!');G.ph='pd';G.st=70;}
        else {G.ph='pd';G.st=50;}break;}
      case 'dSack':G.los=Math.min(99,G.los+7);G.dn++;
        G.ph='pd';G.st=G.dn>4?70:50;if(G.dn>4)showMsg('TURNOVER ON DOWNS!');break;
      case 'dInc':G.dn++;G.ph='pd';G.st=G.dn>4?70:50;if(G.dn>4)showMsg('TURNOVER ON DOWNS!');break;
      case 'dInt':G.ph='pd';G.st=70;break;
    }
  }
  updSB();
}

function advance(){
  if(G.ppq>=PPQ){G.q++;G.ppq=0;
    if(G.q>G.mq){G.ph='go';
      onGameOver(G.hs,G.as);
      return;}
    showMsg(`QUARTER ${G.q}`,1500);}
  const sw=['td','int','dTD','dInt'].includes(G.pr)||(G.dn>4);
  if(sw){G.pos=G.pos==='h'?'a':'h';G.dn=1;G.ytg=10;G.los=25;}
  updSB();showPM();
}

// === 3D DRAWING ===
function darkenCol(hex,amt){
  let c=hex.replace('#','');if(c.length===3)c=c[0]+c[0]+c[1]+c[1]+c[2]+c[2];
  const r=Math.max(0,parseInt(c.substring(0,2),16)-amt);
  const g=Math.max(0,parseInt(c.substring(2,4),16)-amt);
  const b=Math.max(0,parseInt(c.substring(4,6),16)-amt);
  return `rgb(${r},${g},${b})`;
}
function drawHuman(pp,p){
  const s=pp.s;const u=Math.max(2,6*s);
  const cx=pp.x;
  let baseY=pp.y;
  // Tackle falling effect
  if(p===G.tackleRunner&&G.tackleAnim>0){baseY+=(20-G.tackleAnim)*1.5;}
  // If too small, just draw a dot
  if(s<0.22){
    X.fillStyle=p.col;X.beginPath();X.arc(cx,baseY,Math.max(2,3*s),0,Math.PI*2);X.fill();return;
  }
  const col=p.col;const dark=darkenCol(col,60);const skin='#D4A574';
  // Shadow on ground
  X.fillStyle='rgba(0,0,0,0.22)';X.beginPath();
  X.ellipse(cx,baseY+u*0.4,u*1.1,u*0.35,0,0,Math.PI*2);X.fill();
  // Legs (animated stride)
  const legW=u*0.42,legH=u*1.2;const legGap=u*0.35;
  const legTop=baseY-u*0.5;
  const animPhase=(p.anim||0)>0?Math.floor((p.anim||0)/4)%4:0;
  let lLegOff=0,rLegOff=0;
  if(animPhase===1){lLegOff=-u*0.45;rLegOff=u*0.35;}
  else if(animPhase===3){lLegOff=u*0.35;rLegOff=-u*0.45;}
  X.fillStyle=dark;
  X.fillRect(cx-legGap-legW/2,legTop+lLegOff,legW,legH);
  X.fillRect(cx+legGap-legW/2,legTop+rLegOff,legW,legH);
  // Shoes
  X.fillStyle='#222';
  X.fillRect(cx-legGap-legW/2-u*0.08,legTop+lLegOff+legH-u*0.3,legW+u*0.16,u*0.35);
  X.fillRect(cx+legGap-legW/2-u*0.08,legTop+rLegOff+legH-u*0.3,legW+u*0.16,u*0.35);
  // Torso (rounded rect)
  const tW=u*2.2,tH=u*1.8;const tX=cx-tW/2,tY=baseY-u*2.3;
  const tr=u*0.35;
  X.fillStyle=col;
  X.beginPath();
  X.moveTo(tX+tr,tY);X.lineTo(tX+tW-tr,tY);X.quadraticCurveTo(tX+tW,tY,tX+tW,tY+tr);
  X.lineTo(tX+tW,tY+tH-tr);X.quadraticCurveTo(tX+tW,tY+tH,tX+tW-tr,tY+tH);
  X.lineTo(tX+tr,tY+tH);X.quadraticCurveTo(tX,tY+tH,tX,tY+tH-tr);
  X.lineTo(tX,tY+tr);X.quadraticCurveTo(tX,tY,tX+tr,tY);
  X.closePath();X.fill();
  // Torso shading (subtle lighter top edge)
  X.fillStyle='rgba(255,255,255,0.12)';
  X.fillRect(tX+tr,tY,tW-2*tr,u*0.3);
  // Jersey number on torso
  if(s>0.3){
    const fs=Math.max(5,Math.round(9*s));
    X.fillStyle='#fff';X.font=`bold ${fs}px sans-serif`;X.textAlign='center';X.textBaseline='middle';
    X.fillText(p.n,cx,tY+tH*0.52);
  }
  // Arms (animated opposite to legs)
  const armW=u*0.38,armH=u*1.3;
  let lArmOff=0,rArmOff=0;
  if(animPhase===1){lArmOff=u*0.3;rArmOff=-u*0.25;}
  else if(animPhase===3){lArmOff=-u*0.25;rArmOff=u*0.3;}
  // Throw animation override
  if(p===G.throwPlayer&&G.throwAnim>0){
    if(G.throwAnim>6){rArmOff=-u*1.2;} // windup: arm up
    else{rArmOff=u*0.8;} // release: arm forward/down
  }
  // Catch animation override
  if(p===G.catchPlayer&&G.catchAnim>0){
    lArmOff=-u*1.0;rArmOff=-u*1.0; // both arms raised
  }
  X.fillStyle=skin;
  X.fillRect(tX-armW,tY+u*0.25+lArmOff,armW,armH);
  X.fillRect(tX+tW,tY+u*0.25+rArmOff,armW,armH);
  // Hands
  X.fillStyle=skin;
  X.beginPath();X.arc(tX-armW/2,tY+u*0.25+armH+lArmOff,armW*0.45,0,Math.PI*2);X.fill();
  X.beginPath();X.arc(tX+tW+armW/2,tY+u*0.25+armH+rArmOff,armW*0.45,0,Math.PI*2);X.fill();
  // Neck
  X.fillStyle=skin;
  X.fillRect(cx-u*0.3,tY-u*0.3,u*0.6,u*0.45);
  // Head / Helmet
  const headR=u*0.72;const headY=tY-u*0.55-headR*0.3;
  // Helmet (team color, slightly larger)
  X.fillStyle=col;X.beginPath();X.arc(cx,headY,headR,0,Math.PI*2);X.fill();
  // Helmet outline
  X.strokeStyle='rgba(0,0,0,0.3)';X.lineWidth=Math.max(0.5,1*s);
  X.beginPath();X.arc(cx,headY,headR,0,Math.PI*2);X.stroke();
  // Facemask (white stripe across lower helmet)
  if(s>0.28){
    X.strokeStyle='rgba(255,255,255,0.7)';X.lineWidth=Math.max(0.5,1.2*s);
    X.beginPath();X.moveTo(cx-headR*0.7,headY+headR*0.25);
    X.lineTo(cx+headR*0.7,headY+headR*0.25);X.stroke();
    // Face area (small skin-colored oval)
    X.fillStyle=skin;X.beginPath();
    X.ellipse(cx,headY+headR*0.15,headR*0.35,headR*0.3,0,0,Math.PI*2);X.fill();
  }
  // Helmet stripe (center line on top)
  if(s>0.35){
    X.strokeStyle='rgba(255,255,255,0.4)';X.lineWidth=Math.max(0.5,1.5*s);
    X.beginPath();X.moveTo(cx,headY-headR);X.lineTo(cx,headY-headR*0.1);X.stroke();
  }
  // Ball in hand if carrying
  if(p.hb||p===G.carrier){
    const bx=tX+tW+armW*0.5,by=tY+u*0.25+armH-u*0.2+rArmOff;
    X.fillStyle='#8B4513';X.beginPath();
    X.ellipse(bx,by,u*0.45,u*0.28,0.3,0,Math.PI*2);X.fill();
    X.strokeStyle='#fff';X.lineWidth=Math.max(0.3,0.6*s);
    X.beginPath();X.moveTo(bx-u*0.15,by);X.lineTo(bx+u*0.15,by);X.stroke();
  }
}
function drawP(){
  const sorted=[...P].sort((a,b)=>a.y-b.y);
  for(const p of sorted){
    const pp=project(p.x,p.y);
    // WR highlight ring (under the player)
    if(p.role==='wr'&&p.team==='h'&&G.ph==='live'){
      const hr=Math.max(4,PR*pp.s*1.5);
      X.strokeStyle='#f1c40f';X.lineWidth=Math.max(1,2*pp.s);
      X.beginPath();X.ellipse(pp.x,pp.y+Math.max(1,3*pp.s),hr,hr*0.4,0,0,Math.PI*2);X.stroke();
    }
    // Carrier highlight ring (under the player)
    if(p===G.carrier&&(G.ph==='rac'||G.ph==='run')){
      const hr=Math.max(4,PR*pp.s*1.5);
      X.strokeStyle='#fff';X.lineWidth=Math.max(1,2*pp.s);
      X.beginPath();X.ellipse(pp.x,pp.y+Math.max(1,3*pp.s),hr,hr*0.4,0,0,Math.PI*2);X.stroke();
    }
    // Draw the human figure
    drawHuman(pp,p);
  }
}

function drawBall(){
  if(!ball.air)return;
  const pp=project(ball.x,ball.y);
  const arcOff=(ball.ao||0)*pp.s;
  const ss=1+Math.abs(ball.ao||0)/50;
  X.fillStyle='rgba(0,0,0,0.3)';X.beginPath();
  X.ellipse(pp.x,pp.y,Math.max(2,5*ss*pp.s),Math.max(1,3*pp.s),0,0,Math.PI*2);X.fill();
  const vy=pp.y+arcOff;
  const a=Math.atan2(ball.ty-ball.sy,ball.tx-ball.sx);
  X.fillStyle='#8B4513';X.beginPath();
  X.ellipse(pp.x,vy,Math.max(2,7*pp.s),Math.max(1,4*pp.s),a,0,Math.PI*2);X.fill();
  X.strokeStyle='#fff';X.lineWidth=Math.max(0.5,1*pp.s);
  X.beginPath();X.moveTo(pp.x-2*pp.s,vy);X.lineTo(pp.x+2*pp.s,vy);X.stroke();
}

function drawAim(){
  if(!drag.active||G.ph!=='live')return;
  const qb=P.find(p=>p.team==='h'&&p.role==='qb');if(!qb)return;
  const sdx=drag.sx-drag.cx,sdy=drag.sy-drag.cy;
  const dr=Math.hypot(sdx,sdy);if(dr<5)return;
  const pw=Math.min(dr,MAX_POWER);
  const snx=sdx/dr,sny=sdy/dr;
  const qbS=project(qb.x,qb.y);
  const stx=qbS.x+snx*pw,sty=qbS.y+sny*pw;
  const wt=unproject(stx,sty);
  const tx=wt.x,ty=wt.y;
  const ah=pw*0.12;
  X.strokeStyle='rgba(255,255,100,0.5)';X.lineWidth=2;X.setLineDash([4,4]);
  X.beginPath();
  for(let t=0;t<=1;t+=0.02){
    const wx=qb.x+(tx-qb.x)*t,wy=qb.y+(ty-qb.y)*t;
    const arc=-ah*4*t*(1-t);
    const pp=project(wx,wy);
    const sArc=arc*pp.s;
    t===0?X.moveTo(pp.x,pp.y+sArc):X.lineTo(pp.x,pp.y+sArc);
  }
  X.stroke();X.setLineDash([]);
  const ppL=project(tx,ty);
  X.strokeStyle='rgba(255,255,100,0.35)';X.lineWidth=1;
  X.beginPath();X.arc(ppL.x,ppL.y,Math.max(4,gCATCH_R*ppL.s),0,Math.PI*2);X.stroke();
  const ppQ=project(qb.x,qb.y);
  const ppw=pw/MAX_POWER;const bw=Math.max(20,50*ppQ.s),bh=Math.max(3,5*ppQ.s);
  X.fillStyle='rgba(0,0,0,0.5)';X.fillRect(ppQ.x-bw/2,ppQ.y+22*ppQ.s,bw,bh);
  X.fillStyle=ppw<0.5?'#2ecc71':ppw<0.8?'#f1c40f':'#e74c3c';
  X.fillRect(ppQ.x-bw/2,ppQ.y+22*ppQ.s,bw*ppw,bh);
}

function drawRoutes(){
  if(G.ph!=='live')return;
  X.globalAlpha=0.25;
  P.filter(p=>p.team==='h'&&p.role==='wr').forEach(wr=>{
    const rt=R[wr.route];if(!rt)return;
    X.strokeStyle='#fff';X.lineWidth=1.5;X.setLineDash([3,3]);
    X.beginPath();
    const ppS=project(wr.sx,wr.sy);
    X.moveTo(ppS.x,ppS.y);
    for(let t=0;t<=55;t+=2){
      const o=rt(t);
      const wx=clamp(wr.sx+o.dx,15,W-15),wy=clamp(wr.sy+o.dy,YPX,H-YPX);
      const pp=project(wx,wy);
      X.lineTo(pp.x,pp.y);
    }
    X.stroke();X.setLineDash([]);
  });
  X.globalAlpha=1;
}

function drawStam(){
  if(G.ph!=='rac'&&G.ph!=='run')return;
  const c=G.carrier;if(!c)return;
  const pp=project(c.x,c.y);
  const bw=Math.max(14,28*pp.s),bh=Math.max(2,4*pp.s);
  const bx=pp.x-bw/2,by=pp.y-(PR+7)*pp.s;
  X.fillStyle='rgba(0,0,0,0.5)';X.fillRect(bx,by,bw,bh);
  const pc=G.stam/gSTAM_MAX;
  X.fillStyle=pc>0.5?'#2ecc71':pc>0.2?'#f1c40f':'#e74c3c';
  X.fillRect(bx,by,bw*pc,bh);
}

// === PARTICLES ===
function mkP(x,y,c,n){for(let i=0;i<n;i++)parts.push({x,y,vx:(Math.random()-0.5)*6,vy:(Math.random()-0.5)*6,l:1,d:0.02+Math.random()*0.03,s:2+Math.random()*4,c});}
function updParts(){for(let i=parts.length-1;i>=0;i--){const p=parts[i];p.x+=p.vx;p.y+=p.vy;p.vx*=0.96;p.vy*=0.96;p.l-=p.d;if(p.l<=0)parts.splice(i,1);}}
function drawParts(){
  for(const p of parts){
    const pp=project(p.x,p.y);
    X.globalAlpha=p.l;X.fillStyle=p.c;
    const s=Math.max(1,p.s*pp.s);
    X.fillRect(pp.x-s/2,pp.y-s/2,s,s);
  }
  X.globalAlpha=1;
}

// === UI ===
function showMsg(t,d=1500){msgEl.textContent=t;msgEl.style.opacity='1';setTimeout(()=>msgEl.style.opacity='0',d);}
function showDefenseRoll(dp,cb){
  const el=document.getElementById('diceRoll');
  const names=DPLAYS.map(d=>d.name);
  let count=0;const total=8;
  el.style.opacity='1';
  const iv=setInterval(()=>{
    const rn=names[Math.floor(Math.random()*names.length)];
    const rc=DPLAYS[Math.floor(Math.random()*DPLAYS.length)].color;
    el.innerHTML='<div style="font-size:11px;color:#aaa;margin-bottom:2px;letter-spacing:2px">DEFENSE</div>'+
      '<div style="font-size:16px;margin:2px 0">\u{1F3B2}</div>'+
      '<div style="color:'+rc+';font-size:18px">'+rn+'</div>';
    count++;
    if(count>=total){
      clearInterval(iv);
      el.innerHTML='<div style="font-size:11px;color:#f0c040;margin-bottom:2px;letter-spacing:2px">DEFENSE</div>'+
        '<div style="color:'+dp.color+';font-size:22px;font-weight:bold;text-transform:uppercase">'+dp.name+'</div>';
      setTimeout(()=>{el.style.opacity='0';if(cb)cb();},250);
    }
  },50);
}
function showDefenseConfirm(dp,cb){
  const el=document.getElementById('diceRoll');
  el.innerHTML='<div style="font-size:11px;color:#f0c040;margin-bottom:2px;letter-spacing:2px">YOUR DEFENSE</div>'+
    '<div style="color:'+dp.color+';font-size:22px;font-weight:bold;text-transform:uppercase">'+dp.name+'</div>';
  el.style.opacity='1';
  setTimeout(()=>{el.style.opacity='0';if(cb)cb();},550);
}
function updSB(){
  const team=TEAMS[S.teamIdx];
  sH.textContent=`${team.abbr}: ${G.hs}`;
  let oppAbbr='CPU';
  if(!S.isPlayoffs&&S.week<=13&&S.schedule.length>0){
    oppAbbr=TEAMS[S.schedule[S.week-1].oppIdx].abbr;
  }
  sA.textContent=`${oppAbbr}: ${G.as}`;
  const ord=['1st','2nd','3rd','4th'][G.dn-1]||'4th';
  const side=G.pos==='h'?'OFF':'DEF';
  sI.textContent=`Q${G.q} | ${ord} & ${G.ytg} | ${side}`;
}

// === MAIN LOOP ===
let inGame=false;
function update(){
  if(!inGame)return;
  // Show touch controls only during player-controlled phases
  showTouchControls(['live','rac','run'].includes(G.ph));
  if(G.throwAnim>0){G.throwAnim--;if(G.throwAnim===6&&G.throwPending){executeThrow(G.throwPending.qb,G.throwPending.ddx,G.throwPending.ddy,G.throwPending.power);G.throwPending=null;}}
  if(G.catchAnim>0)G.catchAnim--;
  switch(G.ph){
    case 'live':updLive();break;
    case 'bia':updBIA();break;
    case 'rac':updRAC();break;
    case 'run':updRun();break;
    case 'dl':updDL();break;
    case 'dbia':updDBIA();break;
    case 'drac':updDRAC();break;
    case 'tackle':G.tackleAnim--;if(G.tackleAnim<=0)endPlay(G.pendingEndPlay);break;
    case 'pd':G.st--;if(G.st<=0)advance();break;
  }
  updParts();
  updAnimState();
}
function updAnimState(){
  for(const p of P){
    const dx=p.x-(p.px||p.x),dy=p.y-(p.py||p.y);
    if(Math.abs(dx)>0.3||Math.abs(dy)>0.3){p.anim=(p.anim||0)+1;}
    else{p.anim=0;}
    p.px=p.x;p.py=p.y;
  }
}
function draw(){
  if(!inGame)return;
  drawField();drawRoutes();drawParts();
  if(!['title','pp','go'].includes(G.ph)){drawP();drawBall();drawStam();drawAim();}
}
function loop(){try{update();}catch(e){console.error('update:',e);}try{draw();}catch(e){console.error('draw:',e);}requestAnimationFrame(loop);}

// === APP ENTRY POINT ===
function startApp(){
  const saved=loadGame();
  if(saved){
    showScreen('home');renderHome();
  } else {
    showScreen('teamSelect');renderTeamSelect();
  }
  initGame();
  initTouchControls();
  loop();
}
startApp();
</script>
</body>
</html>
