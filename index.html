<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Retro Football</title>
<style>
* { margin: 0; padding: 0; box-sizing: border-box; }
body {
  background: #111; display: flex; justify-content: center; align-items: center;
  min-height: 100vh; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
  overflow: hidden; user-select: none;
}
#gc { position: relative; }
canvas { display: block; border-radius: 6px; box-shadow: 0 0 30px rgba(0,0,0,0.6); }
#sb {
  position: absolute; top: 0; left: 0; width: 100%;
  display: flex; justify-content: space-between; align-items: center;
  padding: 6px 12px; pointer-events: none; z-index: 2;
}
.sb { background: rgba(0,0,0,0.8); color: #fff; padding: 5px 12px; border-radius: 5px; font-size: 13px; font-weight: bold; letter-spacing: 1px; }
#msg {
  position: absolute; top: 50%; left: 50%; transform: translate(-50%,-50%);
  color: #fff; font-size: 34px; font-weight: bold;
  text-shadow: 2px 2px 6px rgba(0,0,0,0.9);
  pointer-events: none; opacity: 0; transition: opacity 0.3s; z-index: 5;
}
#pm {
  position: absolute; top: 50%; left: 50%; transform: translate(-50%,-50%);
  display: none; flex-direction: column; gap: 8px; z-index: 10;
  background: rgba(0,0,0,0.88); padding: 18px 24px; border-radius: 10px; min-width: 240px;
}
#pm.show { display: flex; }
#pm h3 { color: #f0c040; text-align: center; font-size: 16px; margin-bottom: 2px; }
#pm button {
  padding: 9px 14px; font-size: 14px; font-weight: bold;
  border: 2px solid rgba(255,255,255,0.15); border-radius: 7px;
  cursor: pointer; transition: all 0.15s; color: #fff;
}
#pm button:hover { transform: scale(1.03); filter: brightness(1.2); }
#ov {
  position: absolute; top: 0; left: 0; width: 100%; height: 100%;
  display: flex; flex-direction: column; justify-content: center; align-items: center;
  background: rgba(0,0,0,0.82); border-radius: 6px; z-index: 20;
}
#ov.hidden { display: none; }
#ov h1 { color: #fff; font-size: 40px; margin-bottom: 4px; }
#ov h2 { color: #f0c040; font-size: 22px; margin-bottom: 16px; }
#ov p { color: #bbb; font-size: 14px; margin-bottom: 3px; }
#ov button {
  margin-top: 14px; padding: 11px 32px; font-size: 17px; font-weight: bold;
  background: #2ecc71; color: #fff; border: none; border-radius: 7px; cursor: pointer;
}
#ov button:hover { background: #27ae60; }
.inst { color: #888; font-size: 12px; margin-top: 10px; text-align: center; line-height: 1.5; }
</style>
</head>
<body>
<div id="gc">
  <canvas id="c" width="800" height="600"></canvas>
  <div id="sb">
    <div class="sb" id="sH">YOU: 0</div>
    <div class="sb" id="sI">Q1 | 1st & 10</div>
    <div class="sb" id="sA">CPU: 0</div>
  </div>
  <div id="msg"></div>
  <div id="pm"></div>
  <div id="ov">
    <h1>RETRO FOOTBALL</h1>
    <h2>Drag to Throw. Dodge to Score.</h2>
    <p>Offense: Drag to aim &amp; throw, WASD to scramble/run</p>
    <p>Defense: Pick a scheme, AI plays for you</p>
    <button id="go">KICK OFF</button>
    <div class="inst">
      DRAG from QB to aim (slingshot). Release to throw.<br>
      After catch: WASD to run, SPACE to sprint, Q/E to juke.<br>
      On defense: pick your play and watch.
    </div>
  </div>
</div>
<script>
const C = document.getElementById('c'), X = C.getContext('2d');
const ov = document.getElementById('ov'), pm = document.getElementById('pm');
const msgEl = document.getElementById('msg');
const sH = document.getElementById('sH'), sI = document.getElementById('sI'), sA = document.getElementById('sA');
const W = 800, H = 600, YPX = H / 12, PR = 10;

// === CONSTANTS ===
const CATCH_R = 28, INT_R = 20, SACK_R = 16, TACKLE_R = 16;
const BALL_SPD = 11, QB_SPD = 3, CARRIER_SPD = 3.8, SPRINT_SPD = 5.2;
const STAM_MAX = 100, STAM_DRAIN = 1.5, STAM_REGEN = 0.5;
const DEF_MAN_RATIO = 0.92, BLOCK_START = 55, BLOCK_FULL = 140;
const JUKE_CD = 18, JUKE_DIST = 32;
const MAX_POWER = 320, MIN_POWER = 35;
const PPQ = 5; // plays per quarter

// === PERSPECTIVE CONSTANTS ===
const HORIZON_Y = 75;
const GROUND_Y = 590;
const NEAR_HALF_W = 440;
const FAR_HALF_W = 95;
const PERSP_POW = 0.72;
const WORLD_TOP = YPX;      // 50
const WORLD_BOT = H - YPX;  // 550

// === COLORS ===
const FG1 = '#2d8a4e', FG2 = '#278a45', EZA = '#1a5276', EZB = '#922b21';
const HCOL = '#2980b9', ACOL = '#c0392b', OLCOL = '#1a6fa0';

// === ROUTES ===
const R = {
  streak: t=>({dx:0,dy:-t*3.4}),
  slant: t=>({dx:t<18?0:(t-18)*2.4,dy:-t*2.9}),
  slantL: t=>({dx:t<18?0:-(t-18)*2.4,dy:-t*2.9}),
  out: t=>({dx:t<22?0:(t-22)*3.2,dy:t<22?-t*2.8:-62}),
  outL: t=>({dx:t<22?0:-(t-22)*3.2,dy:t<22?-t*2.8:-62}),
  post: t=>({dx:t<22?0:-(t-22)*1.4,dy:-t*3.1}),
  postR: t=>({dx:t<22?0:(t-22)*1.4,dy:-t*3.1}),
  curl: t=>({dx:0,dy:t<28?-t*2.8:-78+(t-28)*1.2}),
  flat: t=>({dx:t*3.2,dy:t<10?-t*1.4:-14}),
  flatL: t=>({dx:-t*3.2,dy:t<10?-t*1.4:-14}),
  block: t=>({dx:0,dy:-Math.min(t*1.2,18)}),
};

// === PLAYS ===
const OPLAYS = [
  {name:'Short Pass',type:'pass',routes:['slant','out','flat'],color:'#3498db'},
  {name:'Deep Pass',type:'pass',routes:['streak','post','slantL'],color:'#9b59b6'},
  {name:'Spread',type:'pass',routes:['outL','curl','postR'],color:'#e67e22'},
  {name:'HB Draw',type:'run',routes:['block','block','block'],color:'#27ae60'},
  {name:'QB Scramble',type:'scramble',routes:['streak','slant','flat'],color:'#f39c12'},
];
const DPLAYS = [
  {name:'Man Coverage',scheme:'man',aggr:0.92,blitz:0,color:'#e74c3c'},
  {name:'Zone Defense',scheme:'zone',aggr:0.7,blitz:0,color:'#c0392b'},
  {name:'Blitz',scheme:'man',aggr:0.85,blitz:2,color:'#8e44ad'},
  {name:'Prevent',scheme:'zone',aggr:0.5,blitz:0,color:'#2c3e50'},
];
const AI_PLAYS = [
  {routes:['slant','out','flat']},
  {routes:['streak','post','slantL']},
  {routes:['outL','curl','postR']},
  {routes:['flatL','curl','flat']},
];

// === STATE ===
let G={},P=[],ball={},parts=[],curOP=null,curDP=null;
const keys={};
window.addEventListener('keydown',e=>{keys[e.key.toLowerCase()]=true;if(['arrowup','arrowdown','arrowleft','arrowright',' '].includes(e.key.toLowerCase()))e.preventDefault();});
window.addEventListener('keyup',e=>keys[e.key.toLowerCase()]=false);

// === PERSPECTIVE PROJECTION ===
function project(wx, wy) {
  const t = clamp((WORLD_BOT - wy) / (WORLD_BOT - WORLD_TOP), 0, 1);
  const pt = Math.pow(t, PERSP_POW);
  const halfW = NEAR_HALF_W + (FAR_HALF_W - NEAR_HALF_W) * pt;
  const scale = halfW / NEAR_HALF_W;
  const relX = (wx - W / 2) / (W / 2);
  const sx = W / 2 + relX * halfW;
  const sy = GROUND_Y - pt * (GROUND_Y - HORIZON_Y);
  return { x: sx, y: sy, s: scale };
}

function unproject(sx, sy) {
  const pt = clamp((GROUND_Y - sy) / (GROUND_Y - HORIZON_Y), 0, 1);
  const t = Math.pow(pt, 1 / PERSP_POW);
  const halfW = NEAR_HALF_W + (FAR_HALF_W - NEAR_HALF_W) * pt;
  const relX = halfW > 0 ? (sx - W / 2) / halfW : 0;
  const wx = W / 2 + relX * (W / 2);
  const wy = WORLD_BOT - t * (WORLD_BOT - WORLD_TOP);
  return { x: wx, y: wy };
}

function wy2yd(wy) {
  return (H - wy - YPX) / (H - 2 * YPX) * 100;
}

// Mouse
let drag={active:false,sx:0,sy:0,cx:0,cy:0};
C.addEventListener('mousedown',e=>{
  if(G.ph!=='live'||!curOP||curOP.type==='run')return;
  const r=C.getBoundingClientRect();
  drag.sx=(e.clientX-r.left)*(W/r.width);drag.sy=(e.clientY-r.top)*(H/r.height);
  drag.cx=drag.sx;drag.cy=drag.sy;drag.active=true;
});
C.addEventListener('mousemove',e=>{
  if(!drag.active)return;
  const r=C.getBoundingClientRect();
  drag.cx=(e.clientX-r.left)*(W/r.width);drag.cy=(e.clientY-r.top)*(H/r.height);
});
C.addEventListener('mouseup',e=>{
  if(!drag.active){drag.active=false;return;}
  drag.active=false;
  if(G.ph!=='live')return;
  const r=C.getBoundingClientRect();
  const ex=(e.clientX-r.left)*(W/r.width),ey=(e.clientY-r.top)*(H/r.height);
  const sdx=drag.sx-ex,sdy=drag.sy-ey;
  const power=Math.hypot(sdx,sdy);
  if(power<MIN_POWER)return;
  const qb=P.find(p=>p.team==='h'&&p.role==='qb');
  if(!qb||!qb.hb)return;
  // Project QB to screen, compute screen target, unproject to world
  const qbS=project(qb.x,qb.y);
  const snx=sdx/power,sny=sdy/power;
  const dist=Math.min(power,MAX_POWER);
  const stx=qbS.x+snx*dist,sty=qbS.y+sny*dist;
  const wt=unproject(stx,sty);
  const wdx=wt.x-qb.x,wdy=wt.y-qb.y;
  doThrow(qb,wdx,wdy,Math.hypot(wdx,wdy));
});
// Touch
C.addEventListener('touchstart',e=>{e.preventDefault();
  if(G.ph!=='live'||!curOP||curOP.type==='run')return;
  const t=e.touches[0],r=C.getBoundingClientRect();
  drag.sx=(t.clientX-r.left)*(W/r.width);drag.sy=(t.clientY-r.top)*(H/r.height);
  drag.cx=drag.sx;drag.cy=drag.sy;drag.active=true;
},{passive:false});
C.addEventListener('touchmove',e=>{e.preventDefault();
  if(!drag.active)return;const t=e.touches[0],r=C.getBoundingClientRect();
  drag.cx=(t.clientX-r.left)*(W/r.width);drag.cy=(t.clientY-r.top)*(H/r.height);
},{passive:false});
C.addEventListener('touchend',e=>{e.preventDefault();
  if(!drag.active){drag.active=false;return;}drag.active=false;
  if(G.ph!=='live')return;
  const sdx=drag.sx-drag.cx,sdy=drag.sy-drag.cy;const power=Math.hypot(sdx,sdy);
  if(power<MIN_POWER)return;
  const qb=P.find(p=>p.team==='h'&&p.role==='qb');if(!qb||!qb.hb)return;
  const qbS=project(qb.x,qb.y);
  const snx=sdx/power,sny=sdy/power;
  const dist=Math.min(power,MAX_POWER);
  const stx=qbS.x+snx*dist,sty=qbS.y+sny*dist;
  const wt=unproject(stx,sty);
  const wdx=wt.x-qb.x,wdy=wt.y-qb.y;
  doThrow(qb,wdx,wdy,Math.hypot(wdx,wdy));
},{passive:false});

function doThrow(qb,ddx,ddy,power){
  const dist=Math.min(power,MAX_POWER);const mag=Math.hypot(ddx,ddy);
  const nx=ddx/mag,ny=ddy/mag;
  // Pressure scatter
  let scatter=0;
  P.filter(p=>p.team==='a'&&p.role==='dl').forEach(d=>{
    const dd=Math.hypot(d.x-qb.x,d.y-qb.y);scatter=Math.max(scatter,Math.max(0,1-dd/90)*35);
  });
  const ox=(Math.random()-0.5)*scatter,oy=(Math.random()-0.5)*scatter;
  ball.sx=qb.x;ball.sy=qb.y;
  ball.tx=clamp(qb.x+nx*dist+ox,20,W-20);ball.ty=clamp(qb.y+ny*dist+oy,YPX,H-YPX);
  ball.x=qb.x;ball.y=qb.y;ball.air=true;ball.t=0;
  const fd=Math.hypot(ball.tx-qb.x,ball.ty-qb.y);
  ball.tt=Math.max(10,fd/BALL_SPD);ball.arc=fd*0.12;
  qb.hb=false;
  // Find closest receiver to landing spot (future position)
  const recs=P.filter(p=>p.team==='h'&&p.role==='wr');
  let best=null,bd=Infinity;
  for(const rc of recs){
    const rt=R[rc.route];if(!rt)continue;
    const ft=G.clk+ball.tt;const off=rt(ft);
    const fx=clamp(rc.sx+off.dx,15,W-15),fy=clamp(rc.sy+off.dy,YPX+5,H-YPX-5);
    const d=Math.hypot(fx-ball.tx,fy-ball.ty);
    if(d<bd){bd=d;best=rc;}
  }
  G.target=best;G.ph='bia';
}

function clamp(v,mn,mx){return Math.max(mn,Math.min(mx,v));}

// === INIT ===
function init(){
  G={hs:0,as:0,q:1,mq:4,pos:'h',dn:1,ytg:10,los:25,ph:'title',
     clk:0,st:0,pr:'',ppq:0,target:null,carrier:null,
     stam:STAM_MAX,sprint:false,jcd:0,aiTF:0};
  updSB();
}
function reset(){
  init();G.ph='pp';G.pos='h';ov.classList.add('hidden');showPM();
}

// === YARD <-> Y ===
function y2y(yd){return H-(yd/100)*(H-2*YPX)-YPX;}

// === FIELD (3D PERSPECTIVE) ===
function drawField(){
  // Background — dark stadium
  X.fillStyle='#0d0d1a';
  X.fillRect(0,0,W,H);

  // Sky gradient above horizon
  const skyG=X.createLinearGradient(0,0,0,HORIZON_Y+15);
  skyG.addColorStop(0,'#0a0a18');
  skyG.addColorStop(1,'#141428');
  X.fillStyle=skyG;
  X.fillRect(0,0,W,HORIZON_Y+15);

  // Draw stadium/crowd on sides
  drawCrowd();

  // Field strips (perspective trapezoids)
  const STRIPS=28;
  const stripH=(WORLD_BOT-WORLD_TOP)/STRIPS;
  for(let i=0;i<STRIPS;i++){
    const wyNear=WORLD_BOT-i*stripH;
    const wyFar=WORLD_BOT-(i+1)*stripH;
    const pNL=project(0,wyNear),pNR=project(W,wyNear);
    const pFL=project(0,wyFar),pFR=project(W,wyFar);
    // Determine color
    const ydNear=wy2yd(wyNear),ydFar=wy2yd(wyFar);
    let col;
    if(ydNear<0||ydFar<0) col=EZB;
    else if(ydNear>100||ydFar>100) col=EZA;
    else col=i%2===0?FG1:FG2;
    X.fillStyle=col;
    X.beginPath();
    X.moveTo(pNL.x,pNL.y);X.lineTo(pNR.x,pNR.y);
    X.lineTo(pFR.x,pFR.y);X.lineTo(pFL.x,pFL.y);
    X.closePath();X.fill();
  }

  // Endzone text
  const ezTopWY=y2y(95);const pEZT=project(W/2,ezTopWY);
  const ezFs=Math.max(7,Math.round(18*pEZT.s));
  X.fillStyle='rgba(255,255,255,0.3)';X.font=`bold ${ezFs}px sans-serif`;X.textAlign='center';
  X.fillText('E N D Z O N E',pEZT.x,pEZT.y);
  const ezBotWY=y2y(5);const pEZB=project(W/2,ezBotWY);
  const ezBFs=Math.max(8,Math.round(18*pEZB.s));
  X.font=`bold ${ezBFs}px sans-serif`;
  X.fillText('E N D Z O N E',pEZB.x,pEZB.y);

  // Sidelines (white lines along field edges)
  X.strokeStyle='rgba(255,255,255,0.5)';X.lineWidth=2;
  const slBotL=project(0,WORLD_BOT+10),slBotR=project(W,WORLD_BOT+10);
  const slTopL=project(0,WORLD_TOP-10),slTopR=project(W,WORLD_TOP-10);
  X.beginPath();X.moveTo(slBotL.x,slBotL.y);X.lineTo(slTopL.x,slTopL.y);X.stroke();
  X.beginPath();X.moveTo(slBotR.x,slBotR.y);X.lineTo(slTopR.x,slTopR.y);X.stroke();

  // Yard lines
  for(let yd=10;yd<=90;yd+=10){
    const wy=y2y(yd);
    const pL=project(40,wy),pR=project(W-40,wy);
    X.strokeStyle='rgba(255,255,255,0.4)';
    X.lineWidth=Math.max(0.5,1.5*pL.s);
    X.beginPath();X.moveTo(pL.x,pL.y);X.lineTo(pR.x,pR.y);X.stroke();
  }

  // Hash marks along sidelines every 5 yards
  for(let yd=5;yd<=95;yd+=5){
    if(yd%10===0)continue;
    const wy=y2y(yd);
    const pL1=project(35,wy),pL2=project(50,wy);
    const pR1=project(W-35,wy),pR2=project(W-50,wy);
    X.strokeStyle='rgba(255,255,255,0.2)';
    X.lineWidth=Math.max(0.5,1*pL1.s);
    X.beginPath();X.moveTo(pL1.x,pL1.y);X.lineTo(pL2.x,pL2.y);X.stroke();
    X.beginPath();X.moveTo(pR1.x,pR1.y);X.lineTo(pR2.x,pR2.y);X.stroke();
  }

  // Yard numbers
  X.fillStyle='rgba(255,255,255,0.3)';
  for(let yd=10;yd<=90;yd+=10){
    const label=yd<=50?yd:100-yd;
    const wy=y2y(yd);
    const pL=project(22,wy),pR=project(W-22,wy);
    const fs=Math.max(5,Math.round(14*pL.s));
    X.font=`bold ${fs}px sans-serif`;X.textAlign='center';
    X.fillText(label,pL.x,pL.y+fs*0.35);
    X.fillText(label,pR.x,pR.y+fs*0.35);
  }

  // LOS (yellow dashed)
  const losWY=y2y(G.los);
  const losL=project(0,losWY),losR=project(W,losWY);
  X.strokeStyle='#f1c40f';X.lineWidth=Math.max(1,2.5*losL.s);X.setLineDash([6,4]);
  X.beginPath();X.moveTo(losL.x,losL.y);X.lineTo(losR.x,losR.y);X.stroke();X.setLineDash([]);

  // First down line (red dashed)
  const fd=Math.min(100,G.los+G.ytg);
  if(fd<=100){
    const fdWY=y2y(fd);
    const fdL=project(0,fdWY),fdR=project(W,fdWY);
    X.strokeStyle='#e74c3c';X.lineWidth=Math.max(1,2.5*fdL.s);X.setLineDash([6,4]);
    X.beginPath();X.moveTo(fdL.x,fdL.y);X.lineTo(fdR.x,fdR.y);X.stroke();X.setLineDash([]);
    // Arrows
    const as=Math.max(3,7*fdL.s);
    X.fillStyle='#e74c3c';
    X.beginPath();X.moveTo(fdL.x+2,fdL.y);X.lineTo(fdL.x+2+as*1.3,fdL.y-as);X.lineTo(fdL.x+2+as*1.3,fdL.y+as);X.fill();
    X.beginPath();X.moveTo(fdR.x-2,fdR.y);X.lineTo(fdR.x-2-as*1.3,fdR.y-as);X.lineTo(fdR.x-2-as*1.3,fdR.y+as);X.fill();
  }
}

function drawCrowd(){
  // Simple crowd on left and right sides of the perspective field
  // Draw rows of small colored blocks to suggest stadium crowd
  const colors=['#553322','#442211','#332211','#664433','#443322','#554422','#663344','#225566'];
  const seed=42;
  for(let row=0;row<18;row++){
    const t=row/18;
    const pt=Math.pow(t,PERSP_POW);
    const halfW=NEAR_HALF_W+(FAR_HALF_W-NEAR_HALF_W)*pt;
    const sy=GROUND_Y-pt*(GROUND_Y-HORIZON_Y);
    const cx=W/2;
    const leftEdge=cx-halfW;
    const rightEdge=cx+halfW;
    const s=Math.max(2,5*(1-pt));
    // Left crowd
    for(let j=0;j<6;j++){
      const x=leftEdge-8-j*s*1.3;
      if(x<0)continue;
      const ci=(row*7+j*13+seed)%colors.length;
      X.fillStyle=colors[ci];
      X.fillRect(x-s/2,sy-s/2,s,s*0.8);
    }
    // Right crowd
    for(let j=0;j<6;j++){
      const x=rightEdge+8+j*s*1.3;
      if(x>W)continue;
      const ci=(row*11+j*7+seed)%colors.length;
      X.fillStyle=colors[ci];
      X.fillRect(x-s/2,sy-s/2,s,s*0.8);
    }
  }
}

// === PLAY MENU ===
function showPM(){
  pm.innerHTML='';const t=document.createElement('h3');
  if(G.pos==='h'){
    t.textContent='OFFENSE';pm.appendChild(t);
    OPLAYS.forEach((p,i)=>{const b=document.createElement('button');
      b.textContent=p.name;b.style.background=p.color;
      b.addEventListener('click',()=>selOff(i));pm.appendChild(b);});
  } else {
    t.textContent='DEFENSE';pm.appendChild(t);
    DPLAYS.forEach((p,i)=>{const b=document.createElement('button');
      b.textContent=p.name;b.style.background=p.color;
      b.addEventListener('click',()=>selDef(i));pm.appendChild(b);});
  }
  pm.classList.add('show');G.ph='pp';
}

function selOff(i){
  curOP=OPLAYS[i];curDP=DPLAYS[Math.floor(Math.random()*DPLAYS.length)];
  pm.classList.remove('show');
  setupOff();setupAIDef();assignDef();
  G.ph='pre';G.clk=0;
  ball={x:W/2,y:y2y(G.los),air:false,sx:0,sy:0,tx:0,ty:0,tt:0,t:0,arc:0};
  setTimeout(()=>{if(G.ph==='pre'){G.ph=curOP.type==='run'?'run':curOP.type==='scramble'?'run':'live';G.clk=0;}},700);
}
function selDef(i){
  curDP=DPLAYS[i];pm.classList.remove('show');
  setupAIOff();setupPlayerDef();assignPlayerDef();
  G.ph='pre';G.clk=0;G.aiTF=50+Math.floor(Math.random()*25);
  ball={x:W/2,y:y2y(G.los),air:false,sx:0,sy:0,tx:0,ty:0,tt:0,t:0,arc:0};
  setTimeout(()=>{if(G.ph==='pre')G.ph='dl';G.clk=0;},700);
}

// === SETUP PLAYER OFFENSE ===
function setupOff(){
  P=[];const ly=y2y(G.los);
  P.push({team:'h',role:'qb',x:W/2,y:ly+40,sx:W/2,sy:ly+40,n:7,col:HCOL,hb:true});
  for(let i=0;i<5;i++){const ox=W/2+(i-2)*26;
    P.push({team:'h',role:'ol',x:ox,y:ly+5,sx:ox,sy:ly+5,n:70+i,col:OLCOL,hb:false,bdt:0});}
  const rp=[{x:W/2-180,y:ly-2},{x:W/2+180,y:ly-2},{x:W/2-70,y:ly+18}];
  const rn=[81,88,32];
  for(let i=0;i<curOP.routes.length;i++){
    P.push({team:'h',role:'wr',x:rp[i].x,y:rp[i].y,sx:rp[i].x,sy:rp[i].y,
      n:rn[i],col:HCOL,route:curOP.routes[i],hb:false,caught:false});}
  if(curOP.type==='run'){
    P.push({team:'h',role:'rb',x:W/2,y:ly+55,sx:W/2,sy:ly+55,n:28,col:HCOL,hb:false});}
}

function setupAIDef(){
  const ly=y2y(G.los);
  const dp=[
    {x:W/2-155,y:ly-35,role:'cb',n:21},{x:W/2+155,y:ly-35,role:'cb',n:24},
    {x:W/2-40,y:ly-18,role:'lb',n:55},{x:W/2+40,y:ly-18,role:'lb',n:52},
    {x:W/2,y:ly-80,role:'sf',n:31},
    {x:W/2-30,y:ly-3,role:'dl',n:91},{x:W/2,y:ly-3,role:'dl',n:95},{x:W/2+30,y:ly-3,role:'dl',n:97},
  ];
  dp.forEach(d=>P.push({team:'a',role:d.role,x:d.x,y:d.y,sx:d.x,sy:d.y,n:d.n,col:ACOL,hb:false,ar:null,zone:null,bdt:0}));
}

function setupAIOff(){
  P=[];const ly=y2y(G.los);
  const aip=AI_PLAYS[Math.floor(Math.random()*AI_PLAYS.length)];
  P.push({team:'a',role:'qb',x:W/2,y:ly-35,sx:W/2,sy:ly-35,n:10,col:ACOL,hb:true,ai:true});
  for(let i=0;i<5;i++){const ox=W/2+(i-2)*26;
    P.push({team:'a',role:'ol',x:ox,y:ly-5,sx:ox,sy:ly-5,n:70+i,col:'#a93226',hb:false,ai:true,bdt:0});}
  const rp=[{x:W/2-160,y:ly},{x:W/2+160,y:ly},{x:W/2-55,y:ly-10}];
  const rn=[80,87,83];
  for(let i=0;i<aip.routes.length;i++){
    P.push({team:'a',role:'wr',x:rp[i].x,y:rp[i].y,sx:rp[i].x,sy:rp[i].y,
      n:rn[i],col:ACOL,route:aip.routes[i],hb:false,caught:false,ai:true});}
}

function setupPlayerDef(){
  const ly=y2y(G.los);
  const dp=[
    {x:W/2-140,y:ly+35,role:'cb',n:21},{x:W/2+140,y:ly+35,role:'cb',n:24},
    {x:W/2-45,y:ly+12,role:'lb',n:55},{x:W/2+45,y:ly+12,role:'lb',n:52},
    {x:W/2,y:ly+65,role:'sf',n:31},
    {x:W/2-25,y:ly+4,role:'dl',n:91},{x:W/2+25,y:ly+4,role:'dl',n:97},
  ];
  dp.forEach(d=>P.push({team:'h',role:d.role,x:d.x,y:d.y,sx:d.x,sy:d.y,n:d.n,col:HCOL,hb:false,ar:null,zone:null,aiD:true,bdt:0}));
}

function assignDef(){
  const wrs=P.filter(p=>p.team==='h'&&p.role==='wr');
  const defs=P.filter(p=>p.team==='a'&&['cb','lb','sf'].includes(p.role));
  if(curDP.scheme==='man'){
    for(let i=0;i<defs.length&&i<wrs.length;i++)defs[i].ar=wrs[i];
    for(let i=wrs.length;i<defs.length;i++){const ly=y2y(G.los);defs[i].zone={x:W/2,y:ly-60,r:120};}
  } else {
    const ly=y2y(G.los);
    const zones=[{x:W*0.2,y:ly-55,r:95},{x:W*0.8,y:ly-55,r:95},{x:W*0.4,y:ly-35,r:75},
      {x:W*0.6,y:ly-35,r:75},{x:W*0.5,y:ly-110,r:120}];
    for(let i=0;i<defs.length;i++)defs[i].zone=zones[i%zones.length];
  }
}
function assignPlayerDef(){
  const wrs=P.filter(p=>p.team==='a'&&p.role==='wr');
  const defs=P.filter(p=>p.team==='h'&&['cb','lb','sf'].includes(p.role));
  if(curDP.scheme==='man'){
    for(let i=0;i<defs.length&&i<wrs.length;i++)defs[i].ar=wrs[i];
    for(let i=wrs.length;i<defs.length;i++){const ly=y2y(G.los);defs[i].zone={x:W/2,y:ly+60,r:120};}
  } else {
    const ly=y2y(G.los);
    const zones=[{x:W*0.2,y:ly+55,r:95},{x:W*0.8,y:ly+55,r:95},{x:W*0.4,y:ly+35,r:75},
      {x:W*0.6,y:ly+35,r:75},{x:W*0.5,y:ly+110,r:120}];
    for(let i=0;i<defs.length;i++)defs[i].zone=zones[i%zones.length];
  }
}

// === UPDATE FUNCTIONS === (ALL UNCHANGED — world-space logic)

function updLive(){
  G.clk++;
  const qb=P.find(p=>p.team==='h'&&p.role==='qb');
  if(qb&&qb.hb){
    let dx=0,dy=0;
    if(keys['arrowleft']||keys['a'])dx-=1;if(keys['arrowright']||keys['d'])dx+=1;
    if(keys['arrowup']||keys['w'])dy-=1;if(keys['arrowdown']||keys['s'])dy+=1;
    if(dx&&dy){dx*=0.707;dy*=0.707;}
    qb.x+=dx*QB_SPD;qb.y+=dy*QB_SPD;
    qb.x=clamp(qb.x,20,W-20);qb.y=clamp(qb.y,YPX,H-YPX);
    ball.x=qb.x;ball.y=qb.y;
  }
  P.filter(p=>p.team==='h'&&p.role==='wr').forEach(wr=>{
    if(wr.caught)return;const rt=R[wr.route];if(!rt)return;
    const o=rt(G.clk);wr.x=clamp(wr.sx+o.dx,15,W-15);wr.y=clamp(wr.sy+o.dy,YPX+5,H-YPX-5);
  });
  updOLBlock('h','a');
  updAIDef(qb);
  if(qb&&qb.hb){for(const d of P.filter(p=>p.team==='a'&&p.role==='dl')){
    if(Math.hypot(d.x-qb.x,d.y-qb.y)<SACK_R){mkP(qb.x,qb.y,'#e74c3c',15);endPlay('sack');return;}}}
  if(G.clk>200&&qb&&qb.hb){
    const recs=P.filter(p=>p.team==='h'&&p.role==='wr');
    if(recs.length>0){const t=recs[Math.floor(Math.random()*recs.length)];
      const ddx=t.x-qb.x,ddy=t.y-qb.y;doThrow(qb,ddx,ddy,Math.hypot(ddx,ddy));}}
}

function updBIA(){
  G.clk++;ball.t++;
  const pr=Math.min(1,ball.t/ball.tt);
  ball.x=ball.sx+(ball.tx-ball.sx)*pr;ball.y=ball.sy+(ball.ty-ball.sy)*pr;
  ball.ao=-ball.arc*4*pr*(1-pr);
  P.filter(p=>p.team==='h'&&p.role==='wr').forEach(wr=>{
    if(wr.caught)return;const rt=R[wr.route];if(!rt)return;
    const o=rt(G.clk);wr.x=clamp(wr.sx+o.dx,15,W-15);wr.y=clamp(wr.sy+o.dy,YPX+5,H-YPX-5);
  });
  const dp=curDP||DPLAYS[0];
  P.filter(p=>p.team==='a').forEach(d=>{
    if(d.role==='sf'&&ball.air){
      const bx=ball.tx-d.x,by=ball.ty-d.y,bd=Math.hypot(bx,by);
      if(bd>5){d.x+=bx/bd*3.8;d.y+=by/bd*3.8;}
    } else if(d.ar){
      const rx=d.ar.x-d.x,ry=d.ar.y-d.y,rd=Math.hypot(rx,ry);
      if(rd>3){d.x+=rx/rd*3;d.y+=ry/rd*3;}
    }
    d.x=clamp(d.x,15,W-15);d.y=clamp(d.y,YPX+5,H-YPX-5);
  });
  if(pr>=1)resolveCatch('h','a');
}

function resolveCatch(offT,defT){
  const tgt=G.target;
  const dtgt=tgt?Math.hypot(tgt.x-ball.tx,tgt.y-ball.ty):Infinity;
  for(const d of P.filter(p=>p.team===defT)){
    const dd=Math.hypot(d.x-ball.tx,d.y-ball.ty);
    if(dd<INT_R){
      const ic=dtgt>CATCH_R?0.75:dd<dtgt?0.35:0.12;
      if(Math.random()<ic){mkP(ball.tx,ball.ty,'#e74c3c',20);showMsg('INTERCEPTED!');
        endPlay(offT==='h'?'int':'dInt');return;}
    }
  }
  if(tgt&&dtgt<CATCH_R){
    tgt.caught=true;tgt.hb=true;ball.air=false;
    G.carrier=tgt;G.stam=STAM_MAX;G.jcd=0;
    mkP(tgt.x,tgt.y,'#2ecc71',12);
    G.ph=offT==='h'?'rac':'drac';
  } else {
    ball.air=false;mkP(ball.tx,ball.ty,'#95a5a6',10);showMsg('INCOMPLETE');
    endPlay(offT==='h'?'inc':'dInc');
  }
}

function updRAC(){
  G.clk++;const c=G.carrier;if(!c)return;
  let dx=0,dy=0;
  if(keys['arrowleft']||keys['a'])dx-=1;if(keys['arrowright']||keys['d'])dx+=1;
  if(keys['arrowup']||keys['w'])dy-=1;if(keys['arrowdown']||keys['s'])dy+=1;
  if(dx&&dy){dx*=0.707;dy*=0.707;}
  G.sprint=keys[' ']&&G.stam>0;
  if(G.sprint)G.stam=Math.max(0,G.stam-STAM_DRAIN);else G.stam=Math.min(STAM_MAX,G.stam+STAM_REGEN);
  const spd=G.sprint?SPRINT_SPD:CARRIER_SPD;
  if(dx===0&&dy===0)dy=-0.4;
  c.x+=dx*spd;c.y+=dy*spd;
  if(G.jcd>0)G.jcd--;
  if(G.jcd===0&&keys['q']){c.x-=JUKE_DIST;G.jcd=JUKE_CD;mkP(c.x+JUKE_DIST,c.y,'#f1c40f',5);}
  if(G.jcd===0&&keys['e']){c.x+=JUKE_DIST;G.jcd=JUKE_CD;mkP(c.x-JUKE_DIST,c.y,'#f1c40f',5);}
  c.x=clamp(c.x,20,W-20);c.y=clamp(c.y,YPX,H-YPX);
  ball.x=c.x;ball.y=c.y;ball.air=false;
  if(c.y<=YPX){mkP(c.x,c.y,'#f1c40f',30);showMsg('TOUCHDOWN!',2000);endPlay('td');return;}
  P.filter(p=>p.team==='a').forEach(d=>{
    const ddx=c.x-d.x,ddy=c.y-d.y,dd=Math.hypot(ddx,ddy);
    const cs=d.role==='dl'?2.6:d.role==='lb'?3.1:3.4;
    if(dd>5){d.x+=ddx/dd*cs;d.y+=ddy/dd*cs;}
    if(dd<TACKLE_R){mkP(c.x,c.y,'#e74c3c',15);endPlay('tkl');}
  });
  if(G.sprint&&Math.random()<0.3)parts.push({x:c.x,y:c.y+8,vx:(Math.random()-0.5),vy:Math.random()*2,l:0.4,d:0.05,s:3,c:'rgba(255,255,255,0.3)'});
}

function updRun(){
  G.clk++;
  const qb=P.find(p=>p.team==='h'&&p.role==='qb');
  const rb=P.find(p=>p.team==='h'&&p.role==='rb');
  if(curOP.type==='scramble'){
    if(G.clk<8){ball.x=qb.x;ball.y=qb.y;return;}
    if(G.clk===8){qb.hb=true;G.carrier=qb;G.stam=STAM_MAX;G.jcd=0;}
  } else {
    if(G.clk<12&&rb&&qb){rb.y-=2.5;ball.x=qb.x;ball.y=qb.y;
      updOLBlock('h','a');updAIDef(qb);return;}
    if(G.clk===12&&rb){qb.hb=false;rb.hb=true;G.carrier=rb;G.stam=STAM_MAX;G.jcd=0;}
  }
  const c=G.carrier;if(!c)return;
  let dx=0,dy=0;
  if(keys['arrowleft']||keys['a'])dx-=1;if(keys['arrowright']||keys['d'])dx+=1;
  if(keys['arrowup']||keys['w'])dy-=1;if(keys['arrowdown']||keys['s'])dy+=1;
  if(dx&&dy){dx*=0.707;dy*=0.707;}
  G.sprint=keys[' ']&&G.stam>0;
  if(G.sprint)G.stam=Math.max(0,G.stam-STAM_DRAIN);else G.stam=Math.min(STAM_MAX,G.stam+STAM_REGEN);
  const spd=G.sprint?SPRINT_SPD:CARRIER_SPD;
  if(dx===0&&dy===0)dy=-0.5;
  c.x+=dx*spd;c.y+=dy*spd;
  if(G.jcd>0)G.jcd--;
  if(G.jcd===0&&keys['q']){c.x-=JUKE_DIST;G.jcd=JUKE_CD;mkP(c.x+JUKE_DIST,c.y,'#f1c40f',5);}
  if(G.jcd===0&&keys['e']){c.x+=JUKE_DIST;G.jcd=JUKE_CD;mkP(c.x-JUKE_DIST,c.y,'#f1c40f',5);}
  c.x=clamp(c.x,20,W-20);c.y=clamp(c.y,YPX,H-YPX);
  ball.x=c.x;ball.y=c.y;ball.air=false;
  updOLBlock('h','a');
  P.filter(p=>p.team==='a').forEach(d=>{
    const ddx=c.x-d.x,ddy=c.y-d.y,dd=Math.hypot(ddx,ddy);
    const cs=d.role==='dl'?2.6:d.role==='lb'?3.1:3.4;
    if(dd>5){d.x+=ddx/dd*cs;d.y+=ddy/dd*cs;}
    if(dd<TACKLE_R){mkP(c.x,c.y,'#e74c3c',15);endPlay('tkl');}
  });
  if(c.y<=YPX){mkP(c.x,c.y,'#f1c40f',30);showMsg('TOUCHDOWN!',2000);endPlay('td');return;}
  if(G.sprint&&Math.random()<0.3)parts.push({x:c.x,y:c.y+8,vx:(Math.random()-0.5),vy:Math.random()*2,l:0.4,d:0.05,s:3,c:'rgba(255,255,255,0.3)'});
}

function updOLBlock(olT,dlT){
  const ols=P.filter(p=>p.team===olT&&p.role==='ol');
  const dls=P.filter(p=>p.team===dlT&&p.role==='dl');
  for(const ol of ols){
    let near=null,nd=Infinity;
    for(const dl of dls){const d=Math.hypot(dl.x-ol.x,dl.y-ol.y);if(d<nd){nd=d;near=dl;}}
    if(near){
      if(nd>18){const dx=near.x-ol.x,dy=near.y-ol.y,d=Math.hypot(dx,dy);
        ol.x+=dx/d*2.5;ol.y+=dy/d*2.5;}
      else {
        const qb=P.find(p=>p.team===olT&&p.role==='qb');
        if(qb){const tx=qb.x-near.x,ty=qb.y-near.y,td=Math.hypot(tx,ty);
          ol.x=near.x+tx/td*14;ol.y=near.y+ty/td*14;}
      }
    }
    ol.x=clamp(ol.x,15,W-15);ol.y=clamp(ol.y,YPX+5,H-YPX-5);
  }
}

function updAIDef(qb){
  const dp=curDP||DPLAYS[0];
  P.filter(p=>p.team==='a').forEach(d=>{
    if(d.role==='dl'){
      const ols=P.filter(p=>p.team==='h'&&p.role==='ol');
      let blocked=false;
      for(const ol of ols){if(Math.hypot(ol.x-d.x,ol.y-d.y)<22){blocked=true;break;}}
      if(blocked)d.bdt=(d.bdt||0)+1; else d.bdt=0;
      const str=blocked?Math.max(0,1-(d.bdt-BLOCK_START)/(BLOCK_FULL-BLOCK_START)):0;
      if(!blocked||str<0.3){
        if(qb){const dx=qb.x-d.x,dy=qb.y-d.y,dd=Math.hypot(dx,dy);
          const sp=2.2*(1-str*0.7);if(dd>5){d.x+=dx/dd*sp;d.y+=dy/dd*sp;}}
      } else {d.x+=(Math.random()-0.5)*0.8;d.y+=(Math.random()-0.5)*0.4;}
    } else if(dp.scheme==='man'&&d.ar){
      const rx=d.ar.x-d.x,ry=d.ar.y-d.y,rd=Math.hypot(rx,ry);
      const sp=2.9*DEF_MAN_RATIO;
      if(rd>3){d.x+=rx/rd*sp;d.y+=ry/rd*sp;}
    } else if(d.zone){
      const zx=d.zone.x-d.x,zy=d.zone.y-d.y,zd=Math.hypot(zx,zy);
      if(zd>d.zone.r){d.x+=zx/zd*2.3;d.y+=zy/zd*2.3;}
      else {
        const nrs=P.filter(p=>p.team==='h'&&p.role==='wr'&&Math.hypot(p.x-d.zone.x,p.y-d.zone.y)<d.zone.r*1.5);
        if(nrs.length>0){let cl=nrs[0],cd=Infinity;
          for(const nr of nrs){const dd=Math.hypot(nr.x-d.x,nr.y-d.y);if(dd<cd){cd=dd;cl=nr;}}
          const rx=cl.x-d.x,ry=cl.y-d.y,rd=Math.hypot(rx,ry);
          if(rd>5){d.x+=rx/rd*2.6;d.y+=ry/rd*2.6;}}
      }
    }
    d.x=clamp(d.x,15,W-15);d.y=clamp(d.y,YPX+5,H-YPX-5);
  });
}

function updDL(){
  G.clk++;
  const aq=P.find(p=>p.team==='a'&&p.role==='qb');
  P.filter(p=>p.team==='a'&&p.role==='wr').forEach(wr=>{
    if(wr.caught)return;const rt=R[wr.route];if(!rt)return;
    const o=rt(G.clk);wr.x=clamp(wr.sx+o.dx,15,W-15);wr.y=clamp(wr.sy-o.dy,YPX+5,H-YPX-5);
  });
  updOLBlock('a','h');
  updPlayerDefAI();
  if(aq&&aq.hb){for(const d of P.filter(p=>p.team==='h'&&p.role==='dl')){
    if(Math.hypot(d.x-aq.x,d.y-aq.y)<SACK_R){mkP(aq.x,aq.y,'#2ecc71',15);showMsg('SACK!');endPlay('dSack');return;}}}
  if(G.clk>=G.aiTF&&aq&&aq.hb&&!ball.air){aiThrow(aq);}
  if(G.clk>G.aiTF+50&&aq&&aq.hb){
    aq.y+=2.2;aq.x+=(W/2-aq.x)*0.03;ball.x=aq.x;ball.y=aq.y;
    if(aq.y>=H-YPX){showMsg('THEY SCORED!');endPlay('dTD');return;}
    for(const d of P.filter(p=>p.team==='h')){
      if(Math.hypot(d.x-aq.x,d.y-aq.y)<TACKLE_R){showMsg('QB TACKLED!');endPlay('dTkl');return;}}
  }
}

function aiThrow(aq){
  const recs=P.filter(p=>p.team==='a'&&p.role==='wr');if(recs.length===0)return;
  let best=null,bs=-Infinity;
  for(const r of recs){
    let md=Infinity;P.filter(p=>p.team==='h').forEach(d=>{md=Math.min(md,Math.hypot(d.x-r.x,d.y-r.y));});
    const sc=md+r.y*0.01;if(sc>bs){bs=sc;best=r;}
  }
  if(!best)return;
  const rt=R[best.route];const ft=G.clk+15;const o=rt(ft);
  const lx=clamp(best.sx+o.dx,20,W-20),ly=clamp(best.sy-o.dy,YPX,H-YPX);
  aq.hb=false;G.target=best;
  ball.x=aq.x;ball.y=aq.y;ball.air=true;ball.t=0;
  ball.sx=aq.x;ball.sy=aq.y;ball.tx=lx;ball.ty=ly;
  const fd=Math.hypot(ball.tx-aq.x,ball.ty-aq.y);
  ball.tt=Math.max(12,fd/8);ball.arc=fd*0.1;
  G.ph='dbia';
}

function updDBIA(){
  G.clk++;ball.t++;
  const pr=Math.min(1,ball.t/ball.tt);
  ball.x=ball.sx+(ball.tx-ball.sx)*pr;ball.y=ball.sy+(ball.ty-ball.sy)*pr;
  ball.ao=-ball.arc*4*pr*(1-pr);
  P.filter(p=>p.team==='a'&&p.role==='wr').forEach(wr=>{
    if(wr.caught)return;const rt=R[wr.route];if(!rt)return;
    const o=rt(G.clk);wr.x=clamp(wr.sx+o.dx,15,W-15);wr.y=clamp(wr.sy-o.dy,YPX+5,H-YPX-5);
  });
  P.filter(p=>p.team==='h'&&p.aiD).forEach(d=>{
    if(d.role==='sf'&&ball.air){
      const bx=ball.tx-d.x,by=ball.ty-d.y,bd=Math.hypot(bx,by);
      if(bd>5){d.x+=bx/bd*3.5;d.y+=by/bd*3.5;}
    } else if(d.ar){
      const rx=d.ar.x-d.x,ry=d.ar.y-d.y,rd=Math.hypot(rx,ry);
      if(rd>3){d.x+=rx/rd*3;d.y+=ry/rd*3;}
    }
    d.x=clamp(d.x,15,W-15);d.y=clamp(d.y,YPX+5,H-YPX-5);
  });
  if(pr>=1)resolveCatch('a','h');
}

function updDRAC(){
  G.clk++;const c=G.carrier;if(!c)return;
  c.y+=3;c.x+=(W/2-c.x)*0.02;
  c.x=clamp(c.x,15,W-15);ball.x=c.x;ball.y=c.y;ball.air=false;
  if(c.y>=H-YPX){mkP(c.x,c.y,'#e74c3c',30);showMsg('THEY SCORED!',2000);endPlay('dTD');return;}
  P.filter(p=>p.team==='h').forEach(d=>{
    const dx=c.x-d.x,dy=c.y-d.y,dd=Math.hypot(dx,dy);
    if(dd>5){d.x+=dx/dd*3.2;d.y+=dy/dd*3.2;}
    if(dd<TACKLE_R){mkP(c.x,c.y,'#2ecc71',15);endPlay('dTkl');}
  });
}

function updPlayerDefAI(){
  const dp=curDP||DPLAYS[0];
  P.filter(p=>p.team==='h'&&p.aiD).forEach(d=>{
    if(d.role==='dl'){
      const aq=P.find(p=>p.team==='a'&&p.role==='qb');
      const ols=P.filter(p=>p.team==='a'&&p.role==='ol');
      let blocked=false;
      for(const ol of ols){if(Math.hypot(ol.x-d.x,ol.y-d.y)<22){blocked=true;break;}}
      if(blocked)d.bdt=(d.bdt||0)+1;else d.bdt=0;
      const str=blocked?Math.max(0,1-(d.bdt-BLOCK_START)/(BLOCK_FULL-BLOCK_START)):0;
      const blitzSpd=dp.blitz>0?3.2:2.2;
      if(!blocked||str<0.3){
        if(aq){const dx=aq.x-d.x,dy=aq.y-d.y,dd=Math.hypot(dx,dy);
          const sp=blitzSpd*(1-str*0.7);if(dd>5){d.x+=dx/dd*sp;d.y+=dy/dd*sp;}}
      } else {d.x+=(Math.random()-0.5)*0.8;d.y+=(Math.random()-0.5)*0.4;}
    } else if(dp.scheme==='man'&&d.ar){
      const rx=d.ar.x-d.x,ry=d.ar.y-d.y,rd=Math.hypot(rx,ry);
      const sp=2.9*dp.aggr;if(rd>3){d.x+=rx/rd*sp;d.y+=ry/rd*sp;}
    } else if(d.zone){
      const zx=d.zone.x-d.x,zy=d.zone.y-d.y,zd=Math.hypot(zx,zy);
      if(zd>d.zone.r){d.x+=zx/zd*2.3;d.y+=zy/zd*2.3;}
      else {
        const nrs=P.filter(p=>p.team==='a'&&p.role==='wr'&&Math.hypot(p.x-d.zone.x,p.y-d.zone.y)<d.zone.r*1.5);
        if(nrs.length>0){let cl=nrs[0],cd=Infinity;
          for(const nr of nrs){const dd=Math.hypot(nr.x-d.x,nr.y-d.y);if(dd<cd){cd=dd;cl=nr;}}
          const rx=cl.x-d.x,ry=cl.y-d.y,rd=Math.hypot(rx,ry);
          if(rd>5){d.x+=rx/rd*2.6;d.y+=ry/rd*2.6;}}
      }
    }
    d.x=clamp(d.x,15,W-15);d.y=clamp(d.y,YPX+5,H-YPX-5);
  });
}

// === END PLAY ===
function endPlay(r){
  G.pr=r;G.ppq++;
  if(G.pos==='h'){
    switch(r){
      case 'td':G.hs+=7;G.ph='pd';G.st=70;break;
      case 'tkl':{
        const c=G.carrier;
        if(c){const yg=Math.max(0,Math.round((y2y(G.los)-c.y)/(H/100)));
          G.los=Math.min(99,G.los+yg);G.ytg-=yg;
          if(G.ytg<=0){G.dn=1;G.ytg=10;showMsg(`1ST DOWN! +${yg} yds`);}
          else {G.dn++;showMsg(yg>0?`TACKLED +${yg} yds`:'NO GAIN');}
        } else G.dn++;
        if(G.dn>4){showMsg('TURNOVER ON DOWNS');G.ph='pd';G.st=70;}
        else {G.ph='pd';G.st=50;}break;}
      case 'sack':G.los=Math.max(1,G.los-7);G.dn++;showMsg('SACKED! -7 yds');
        G.ph='pd';G.st=G.dn>4?70:50;if(G.dn>4)showMsg('TURNOVER ON DOWNS');break;
      case 'inc':G.dn++;G.ph='pd';G.st=G.dn>4?70:50;if(G.dn>4)showMsg('TURNOVER ON DOWNS');break;
      case 'int':G.ph='pd';G.st=70;break;
    }
  } else {
    switch(r){
      case 'dTD':G.as+=7;G.ph='pd';G.st=70;break;
      case 'dTkl':{
        const c=G.carrier;
        if(c){const yg=Math.max(0,Math.round((c.y-y2y(G.los))/(H/100)));
          G.los=Math.max(1,G.los-yg);G.ytg-=yg;
          if(G.ytg<=0){G.dn=1;G.ytg=10;showMsg('FIRST DOWN (CPU)');}
          else G.dn++;
        } else G.dn++;
        if(G.dn>4){showMsg('TURNOVER ON DOWNS!');G.ph='pd';G.st=70;}
        else {G.ph='pd';G.st=50;}break;}
      case 'dSack':G.los=Math.min(99,G.los+7);G.dn++;
        G.ph='pd';G.st=G.dn>4?70:50;if(G.dn>4)showMsg('TURNOVER ON DOWNS!');break;
      case 'dInc':G.dn++;G.ph='pd';G.st=G.dn>4?70:50;if(G.dn>4)showMsg('TURNOVER ON DOWNS!');break;
      case 'dInt':G.ph='pd';G.st=70;break;
    }
  }
  updSB();
}

function advance(){
  if(G.ppq>=PPQ){G.q++;G.ppq=0;
    if(G.q>G.mq){G.ph='go';
      const w=G.hs>G.as?'YOU WIN!':G.hs<G.as?'YOU LOSE':'TIE GAME';
      ov.querySelector('h1').textContent='GAME OVER';
      ov.querySelector('h2').textContent=`${G.hs} - ${G.as} | ${w}`;
      ov.querySelector('button').textContent='PLAY AGAIN';
      ov.classList.remove('hidden');return;}
    showMsg(`QUARTER ${G.q}`,1500);}
  const sw=['td','int','dTD','dInt'].includes(G.pr)||(G.dn>4);
  if(sw){G.pos=G.pos==='h'?'a':'h';G.dn=1;G.ytg=10;G.los=25;}
  updSB();showPM();
}

// === 3D DRAWING ===
function drawP(){
  // Sort by world Y ascending (far players first for depth ordering)
  const sorted=[...P].sort((a,b)=>a.y-b.y);
  for(const p of sorted){
    const pp=project(p.x,p.y);
    const r=Math.max(3,PR*pp.s);
    // Player body (slightly oval for 3D feel)
    X.fillStyle=p.col;X.beginPath();X.ellipse(pp.x,pp.y,r,r*0.85,0,0,Math.PI*2);X.fill();
    // Outline
    X.strokeStyle='rgba(0,0,0,0.3)';X.lineWidth=Math.max(0.5,1*pp.s);
    X.beginPath();X.ellipse(pp.x,pp.y,r,r*0.85,0,0,Math.PI*2);X.stroke();
    // WR highlight
    if(p.role==='wr'&&p.team==='h'&&G.ph==='live'){
      X.strokeStyle='#f1c40f';X.lineWidth=Math.max(1,2*pp.s);
      X.beginPath();X.arc(pp.x,pp.y,r+Math.max(2,4*pp.s),0,Math.PI*2);X.stroke();}
    // Carrier highlight
    if(p===G.carrier&&(G.ph==='rac'||G.ph==='run')){
      X.strokeStyle='#fff';X.lineWidth=Math.max(1,2*pp.s);
      X.beginPath();X.arc(pp.x,pp.y,r+Math.max(2,3*pp.s),0,Math.PI*2);X.stroke();}
    // Jersey number
    if(r>4){
      const fs=Math.max(5,Math.round(8*pp.s));
      X.fillStyle='#fff';X.font=`bold ${fs}px sans-serif`;X.textAlign='center';X.textBaseline='middle';
      X.fillText(p.n,pp.x,pp.y);
    }
  }
}

function drawBall(){
  if(!ball.air)return;
  const pp=project(ball.x,ball.y);
  const arcOff=(ball.ao||0)*pp.s;
  // Shadow
  const ss=1+Math.abs(ball.ao||0)/50;
  X.fillStyle='rgba(0,0,0,0.3)';X.beginPath();
  X.ellipse(pp.x,pp.y,Math.max(2,5*ss*pp.s),Math.max(1,3*pp.s),0,0,Math.PI*2);X.fill();
  // Ball
  const vy=pp.y+arcOff;
  const a=Math.atan2(ball.ty-ball.sy,ball.tx-ball.sx);
  X.fillStyle='#8B4513';X.beginPath();
  X.ellipse(pp.x,vy,Math.max(2,7*pp.s),Math.max(1,4*pp.s),a,0,Math.PI*2);X.fill();
  X.strokeStyle='#fff';X.lineWidth=Math.max(0.5,1*pp.s);
  X.beginPath();X.moveTo(pp.x-2*pp.s,vy);X.lineTo(pp.x+2*pp.s,vy);X.stroke();
}

function drawAim(){
  if(!drag.active||G.ph!=='live')return;
  const qb=P.find(p=>p.team==='h'&&p.role==='qb');if(!qb)return;
  const sdx=drag.sx-drag.cx,sdy=drag.sy-drag.cy;
  const dr=Math.hypot(sdx,sdy);if(dr<5)return;
  const pw=Math.min(dr,MAX_POWER);
  const snx=sdx/dr,sny=sdy/dr;
  // Compute world target via screen projection
  const qbS=project(qb.x,qb.y);
  const stx=qbS.x+snx*pw,sty=qbS.y+sny*pw;
  const wt=unproject(stx,sty);
  const tx=wt.x,ty=wt.y;
  const ah=pw*0.12;
  // Draw projected arc
  X.strokeStyle='rgba(255,255,100,0.5)';X.lineWidth=2;X.setLineDash([4,4]);
  X.beginPath();
  for(let t=0;t<=1;t+=0.02){
    const wx=qb.x+(tx-qb.x)*t,wy=qb.y+(ty-qb.y)*t;
    const arc=-ah*4*t*(1-t);
    const pp=project(wx,wy);
    const sArc=arc*pp.s;
    t===0?X.moveTo(pp.x,pp.y+sArc):X.lineTo(pp.x,pp.y+sArc);
  }
  X.stroke();X.setLineDash([]);
  // Landing circle
  const ppL=project(tx,ty);
  X.strokeStyle='rgba(255,255,100,0.35)';X.lineWidth=1;
  X.beginPath();X.arc(ppL.x,ppL.y,Math.max(4,CATCH_R*ppL.s),0,Math.PI*2);X.stroke();
  // Power bar
  const ppQ=project(qb.x,qb.y);
  const ppw=pw/MAX_POWER;const bw=Math.max(20,50*ppQ.s),bh=Math.max(3,5*ppQ.s);
  X.fillStyle='rgba(0,0,0,0.5)';X.fillRect(ppQ.x-bw/2,ppQ.y+22*ppQ.s,bw,bh);
  X.fillStyle=ppw<0.5?'#2ecc71':ppw<0.8?'#f1c40f':'#e74c3c';
  X.fillRect(ppQ.x-bw/2,ppQ.y+22*ppQ.s,bw*ppw,bh);
}

function drawRoutes(){
  if(G.ph!=='live')return;
  X.globalAlpha=0.25;
  P.filter(p=>p.team==='h'&&p.role==='wr').forEach(wr=>{
    const rt=R[wr.route];if(!rt)return;
    X.strokeStyle='#fff';X.lineWidth=1.5;X.setLineDash([3,3]);
    X.beginPath();
    const ppS=project(wr.sx,wr.sy);
    X.moveTo(ppS.x,ppS.y);
    for(let t=0;t<=55;t+=2){
      const o=rt(t);
      const wx=clamp(wr.sx+o.dx,15,W-15),wy=clamp(wr.sy+o.dy,YPX,H-YPX);
      const pp=project(wx,wy);
      X.lineTo(pp.x,pp.y);
    }
    X.stroke();X.setLineDash([]);
  });
  X.globalAlpha=1;
}

function drawStam(){
  if(G.ph!=='rac'&&G.ph!=='run')return;
  const c=G.carrier;if(!c)return;
  const pp=project(c.x,c.y);
  const bw=Math.max(14,28*pp.s),bh=Math.max(2,4*pp.s);
  const bx=pp.x-bw/2,by=pp.y-(PR+7)*pp.s;
  X.fillStyle='rgba(0,0,0,0.5)';X.fillRect(bx,by,bw,bh);
  const pc=G.stam/STAM_MAX;
  X.fillStyle=pc>0.5?'#2ecc71':pc>0.2?'#f1c40f':'#e74c3c';
  X.fillRect(bx,by,bw*pc,bh);
}

// === PARTICLES ===
function mkP(x,y,c,n){for(let i=0;i<n;i++)parts.push({x,y,vx:(Math.random()-0.5)*6,vy:(Math.random()-0.5)*6,l:1,d:0.02+Math.random()*0.03,s:2+Math.random()*4,c});}
function updParts(){for(let i=parts.length-1;i>=0;i--){const p=parts[i];p.x+=p.vx;p.y+=p.vy;p.vx*=0.96;p.vy*=0.96;p.l-=p.d;if(p.l<=0)parts.splice(i,1);}}
function drawParts(){
  for(const p of parts){
    const pp=project(p.x,p.y);
    X.globalAlpha=p.l;X.fillStyle=p.c;
    const s=Math.max(1,p.s*pp.s);
    X.fillRect(pp.x-s/2,pp.y-s/2,s,s);
  }
  X.globalAlpha=1;
}

// === UI ===
function showMsg(t,d=1500){msgEl.textContent=t;msgEl.style.opacity='1';setTimeout(()=>msgEl.style.opacity='0',d);}
function updSB(){
  sH.textContent=`YOU: ${G.hs}`;sA.textContent=`CPU: ${G.as}`;
  const ord=['1st','2nd','3rd','4th'][G.dn-1]||'4th';
  const side=G.pos==='h'?'OFF':'DEF';
  sI.textContent=`Q${G.q} | ${ord} & ${G.ytg} | ${side}`;
}

// === MAIN LOOP ===
function update(){
  switch(G.ph){
    case 'live':updLive();break;
    case 'bia':updBIA();break;
    case 'rac':updRAC();break;
    case 'run':updRun();break;
    case 'dl':updDL();break;
    case 'dbia':updDBIA();break;
    case 'drac':updDRAC();break;
    case 'pd':G.st--;if(G.st<=0)advance();break;
  }
  updParts();
}
function draw(){
  drawField();drawRoutes();drawParts();
  if(!['title','pp','go'].includes(G.ph)){drawP();drawBall();drawStam();drawAim();}
}
function loop(){update();draw();requestAnimationFrame(loop);}

document.getElementById('go').addEventListener('click',reset);
init();loop();
</script>
</body>
</html>
